{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">


<style>
  .page-shell {
    display: flex;
    align-items: flex-start;
    /* overflow: hidden; Removed to allow sticky descendants */
    width: 100%;
  }

  .side-nav {
    width: 260px;
    background: var(--vet-bg-surface-translucent);
    backdrop-filter: blur(12px);
    border: 1px solid var(--vet-border-light);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
    position: fixed;
    top: 64px;
    left: 0;
    height: calc(100vh - 64px);
    overflow-y: auto;
    transition: transform 0.2s ease, opacity 0.2s ease;
    z-index: 60;
  }

  .side-nav.collapsed {
    transform: translateX(-110%);
    opacity: 0;
    pointer-events: none;
  }

  .side-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.25);
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .side-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }

  .hamburger-toggle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(111, 61, 244, 0.2);
    background: var(--vet-bg-surface);
    border-radius: 12px;
    padding: 0.45rem 0.75rem;
    font-weight: 700;
    color: #4e22c8;
  }

  .side-brand {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    margin-bottom: 1rem;
  }

  .side-brand .title {
    font-family: 'Lexend', sans-serif;
    font-weight: 800;
    color: var(--vet-primary-strong);
  }

  .side-section-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #9ca3af;
    margin: 1rem 0 0.35rem;
  }

  .side-link {
    width: 100%;
    text-align: left;
    border: 0;
    background: transparent;
    padding: 0.55rem 0.75rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    color: var(--vet-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.15s ease, color 0.15s ease;
  }

  .dropdown-item {
    font-size: 1rem;
  }

  .side-link:hover {
    background: var(--vet-bg-subtle);
    color: var(--vet-primary);
  }

  .side-link.active {
    background: var(--vet-primary);
    color: #fff;
    box-shadow: 0 4px 12px var(--vet-shadow-sm);
  }

  .side-nav .dropdown-toggle::after {
    display: none;
  }

  .side-nav .dropdown-menu {
    width: 100%;
  }

  @media (max-width: 992px) {
    .page-shell {
      flex-direction: column;
    }
  }

  .first-workspace-wrapper {
    display: flex;
    justify-content: center;
    padding: 2rem 0 4rem;
  }

  .first-workspace-card {
    width: min(960px, 100%);
    background: rgba(255, 255, 255, 0.96);
    border-radius: 26px;
    padding: 3rem;
    box-shadow: 0 25px 70px rgba(79, 70, 229, 0.15);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 2rem;
  }

  .first-workspace-copy h2 {
    font-family: 'Lexend', sans-serif;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .appointment-card .fw-bold.text-truncate {
    white-space: normal;
    word-break: break-word;
    overflow: visible;
  }

  .slug-input-group .input-group-text {
    background: #f4edff;
    border-color: #e4dafd;
    color: #6f3df4;
    font-weight: 600;
  }

  .slug-helper {
    font-size: 0.85rem;
  }

  @media (max-width: 768px) {
    .first-workspace-card {
      padding: 2rem;
    }
  }

  .calendar-weekdays,
  .calendar-grid {
    min-width: 900px;
  }

  /* Appointments UI Refresh */
  .appointment-card {
    padding: 0.85rem 1rem;
    border-radius: 12px;
    background: #fff;
    border: 1px solid rgba(111, 61, 244, 0.08);
    margin-bottom: 0.6rem;
    transition: all 0.2s ease;
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .appointment-card:hover {
    background: #fbf9ff;
    border-color: rgba(111, 61, 244, 0.25);
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(111, 61, 244, 0.06);
  }

  .app-time {
    font-size: 0.75rem;
    color: #8b7ccf;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .app-title {
    font-weight: 700;
    color: #1f2937;
    font-size: 0.95rem;
    line-height: 1.3;
  }

  .btn-icon-soft {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    color: #9ca3af;
    transition: all 0.2s;
    background: transparent;
    border: 0;
    padding: 0;
    cursor: pointer;
  }

  .btn-icon-soft:hover {
    background: #f3f4f6;
    color: #111;
  }

  .btn-icon-soft.danger:hover {
    background: #fef2f2;
    color: #dc2626;
  }

  .btn-icon-soft.primary:hover {
    background: #eff6ff;
    color: #2563eb;
  }

  /* Summary workspace */
  .summary-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.9fr);
    gap: 1.25rem;
    align-items: stretch;
  }

  .summary-card {
    border-radius: 18px;
    border: 1px solid var(--vet-border-light);
    background: var(--vet-bg-surface);
    box-shadow: var(--vet-shadow-sm);
  }

  .summary-card-body {
    padding: 1.1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    height: 100%;
  }

  .summary-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .summary-title {
    font-weight: 800;
    color: var(--vet-text-main);
    letter-spacing: -0.02em;
  }

  .summary-subtitle {
    margin: 0;
    font-size: 0.82rem;
    color: var(--vet-text-muted);
  }

  .summary-list {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    max-height: 520px;
    overflow-y: auto;
    padding-right: 0.25rem;
  }

  .summary-list .appointment-card {
    margin-bottom: 0;
    border-radius: 14px;
    cursor: pointer;
  }

  .summary-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .summary-kpis {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
  }

  .summary-kpi {
    padding: 0.85rem 0.95rem;
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(111, 61, 244, 0.12), rgba(244, 114, 182, 0.08));
    border: 1px solid var(--vet-border-light);
  }

  .summary-kpi-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--vet-text-muted);
    margin-bottom: 0.25rem;
  }

  .summary-kpi-value {
    font-size: 1.35rem;
    font-weight: 800;
    color: var(--vet-text-main);
  }

  .summary-next {
    padding: 1rem 1.1rem;
    border-radius: 16px;
    background: linear-gradient(140deg, rgba(111, 61, 244, 0.16), rgba(111, 61, 244, 0.05));
    border: 1px solid var(--vet-border-light);
  }

  .summary-next .summary-title {
    font-size: 1rem;
  }

  .summary-next-name {
    font-weight: 700;
    color: var(--vet-text-main);
    margin-bottom: 0.25rem;
  }

  .summary-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .summary-action {
    width: 100%;
    text-align: left;
    border-radius: 12px;
    border: 1px solid var(--vet-border-light);
    background: var(--vet-bg-subtle);
    color: var(--vet-primary);
    font-weight: 600;
    padding: 0.6rem 0.85rem;
    transition: all 0.2s ease;
  }

  .summary-action:hover {
    background: rgba(111, 61, 244, 0.12);
    color: var(--vet-primary-strong);
  }

  @media (max-width: 992px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }

    .page-shell {
      align-items: stretch;
    }

    .page-shell > .flex-grow-1 {
      width: 100%;
    }
  }

  @media (max-width: 500px) {
    #summary {
      width: 100%;
    }

    #summary .summary-grid {
      grid-template-columns: 1fr;
      width: 100%;
    }

    #summary .summary-card,
    #summary .summary-list {
      width: 100%;
      max-width: 100%;
    }
  }

  @media (max-width: 500px) and (max-height: 400px) {
    body[data-active-tab="summary"] .vetflow-nav {
      justify-content: flex-start;
      padding: 0.6rem 1rem;
    }

    body[data-active-tab="summary"] .vetflow-brand,
    body[data-active-tab="summary"] .vetflow-session {
      display: none;
    }

    body[data-active-tab="summary"] .brand-hero {
      display: none;
    }

    #summary .summary-grid {
      gap: 0.75rem;
      width: 100%;
      display: block;
    }

    body[data-active-tab="summary"] .summary-card-body {
      padding: 0.85rem;
    }

    #summary .summary-card,
    #summary .summary-list {
      width: 100%;
      max-width: 100%;
    }

    #summary .summary-card-header {
      align-items: flex-start;
      flex-direction: column;
    }

    #summary .summary-subtitle {
      display: none;
    }

    #summary .summary-stack {
      display: none;
    }

    body[data-active-tab="summary"] .summary-card-header .btn[data-tab-target="calendar"] {
      display: none;
    }

    body[data-active-tab="summary"] .summary-list {
      max-height: 240px;
    }

    body[data-active-tab="summary"] .flex-grow-1.px-4 {
      padding-left: 0.75rem !important;
      padding-right: 0.75rem !important;
    }

    .modal-dialog {
      margin: 0.5rem;
      max-width: calc(100% - 1rem);
    }

    .modal-content {
      border-radius: 14px;
    }

    .modal-header,
    .modal-footer {
      padding: 0.6rem 0.75rem;
    }

    .modal-title {
      font-size: 1rem;
    }

    .modal-body {
      padding: 0.65rem 0.75rem;
      max-height: calc(100vh - 170px);
      overflow-y: auto;
    }

    .modal-footer {
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .modal-footer .btn {
      flex: 1 1 45%;
    }
  }

  /* FullCalendar theme to match panel */
  #fullCalendarRoot .fc {
    --fc-border-color: rgba(111, 61, 244, 0.16);
    --fc-page-bg-color: transparent;
    --fc-today-bg-color: rgba(111, 61, 244, 0.06);
    --fc-neutral-bg-color: rgba(111, 61, 244, 0.04);
    --fc-event-border-color: transparent;
  }

  #fullCalendarRoot .fc .fc-toolbar-title {
    font-family: 'Lexend', sans-serif;
    font-weight: 800;
    color: #2b1a66;
  }

  #fullCalendarRoot .fc .fc-button {
    border-radius: 999px;
    border-color: rgba(111, 61, 244, 0.25);
  }

  #fullCalendarRoot .fc .fc-button-primary {
    background: rgba(111, 61, 244, 0.1);
    border-color: rgba(111, 61, 244, 0.25);
    color: #4e22c8;
  }

  #fullCalendarRoot .fc .fc-button-primary:not(:disabled).fc-button-active,
  #fullCalendarRoot .fc .fc-button-primary:not(:disabled):active {
    background: rgba(111, 61, 244, 0.2);
    border-color: rgba(111, 61, 244, 0.35);
    color: #3b1aa0;
  }

  #fullCalendarRoot .fc .fc-button:focus {
    box-shadow: 0 0 0 0.2rem rgba(111, 61, 244, 0.2);
  }

  #fullCalendarRoot .fc .fc-event {
    border-radius: 12px;
    padding: 2px 4px;
    box-shadow: 0 8px 18px rgba(111, 61, 244, 0.12);
  }

  #fullCalendarRoot .fc .fc-col-header-cell-cushion,
  #fullCalendarRoot .fc .fc-daygrid-day-number {
    color: #4b5563;
    text-decoration: none;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<div id="upload-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
  style="background: rgba(0,0,0,0.35); z-index: 1050; backdrop-filter: blur(2px);">
  <div class="d-flex justify-content-center align-items-center h-100">
    <div class="text-white fw-semibold fs-4">Subiendo archivos...</div>
  </div>
</div>
<div class="side-overlay" id="sideOverlay"></div>

<div class="panel-container px-0 py-4 page-shell">
  <aside class="side-nav collapsed" id="sideNav">
    <div class="side-brand">
      <div class="title">Vetflow</div>
      <div class="text-muted small">{{ current_user_email or current_user_name or 'Invitado' }}</div>
    </div>
    <div class="workspace-switcher mb-3">
      <label class="form-label small text-uppercase text-muted mb-1">Workspace</label>
      <div class="dropdown w-100">
        <button class="btn btn-light w-100 d-flex justify-content-between align-items-center" type="button"
          data-bs-toggle="dropdown">
          <span class="text-truncate">{{ current_workspace.name if current_workspace else "Elegir workspace" }}</span>
          <span class="text-muted">▾</span>
        </button>
        <ul class="dropdown-menu w-100">
          {% if workspaces %}
          {% for ws in workspaces %}
          <li><a class="dropdown-item {% if current_workspace and ws.id == current_workspace.id %}active{% endif %}"
              href="{{ url_for('ui.workspace_by_slug', slug=ws.schema_name) }}">{{ ws.name }}</a></li>
          {% endfor %}
          {% else %}
          <li><span class="dropdown-item-text text-muted">Sin workspaces</span></li>
          {% endif %}
        </ul>
      </div>
      <div class="d-flex flex-column gap-2 mt-3">
        <button class="btn btn-outline-secondary w-100 btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#inviteWorkspaceModal" {% if not current_workspace %}disabled{% endif %}>Invitar a
          workspace</button>
        <button class="btn btn-outline-secondary w-100 btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#acceptInviteModal">Tengo un codigo</button>
        <button class="btn btn-outline-secondary w-100 btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#membersWorkspaceModal" {% if not current_workspace %}disabled{% endif %}>Miembros del
          workspace</button>
        {% if current_membership_role == 'owner' %}
        <button class="btn btn-outline-danger w-100 btn-sm" type="button" data-bs-toggle="modal"
          data-bs-target="#deleteWorkspaceModal">Eliminar workspace</button>
        {% endif %}
        <button class="btn btn-light w-100 btn-sm" data-bs-toggle="modal" data-bs-target="#createWorkspaceModal">Crear
          workspace</button>
      </div>
    </div>
    <div class="side-section-title">Navegación</div>
    <button class="side-link" data-tab-target="files">Archivos</button>
    <button class="side-link" data-tab-target="calendar">Calendario</button>
    <button class="side-link" data-tab-target="clients">Gestionar clientes</button>
    <button class="side-link" data-tab-target="whatsapp">Integración WhatsApp</button>
    {% if current_workspace %}
    <button class="side-link" data-tab-target="summary" type="button">Resumen workspace</button>
    {% endif %}
  </aside>
  <div class="side-overlay" id="sideOverlay"></div>

  <div class="flex-grow-1 px-4" style="min-width: 0; overflow-x: hidden;">


    {% if current_workspace %}
    <div class="brand-hero p-3 mb-3 position-relative">
      <div class="row align-items-center g-3">
        <div class="col-md-8 d-flex align-items-center gap-3">
          <div class="brand-logo shadow-sm" style="padding: 0.5rem; border-radius: 16px;">
            <img src="{{ url_for('static', filename='img/control-vet-logo.png') }}" alt="Logo Control Vet"
              style="max-width: 140px;">
          </div>
          <div>
            <div class="brand-chip mb-1" style="font-size: 0.75rem;"><span class="dot"
                style="width: 8px; height: 8px;"></span> {{ current_workspace.name }}</div>
            <h1 class="brand-title mb-0" style="font-size: 1.75rem;">Panel {{ current_workspace.name }}</h1>
            <p class="mb-0 brand-subtitle small opacity-75">
              {{ current_workspace.description or "Gestor documental y agenda conectada a RAG para tu clinica." }}
            </p>
          </div>
        </div>
        <div class="col-md-5 col-lg-4 d-flex gap-2 justify-content-md-end flex-wrap">
          <div class="stat-pill d-flex flex-column justify-content-center px-4" style="min-width: 130px;">
            <small style="font-size: 0.7rem; opacity: 0.85;">Propietario</small>
            <div class="h6 mb-0 text-truncate" style="max-width: 140px;">{{ current_workspace.owner_name or "Sin nombre"
              }}</div>
          </div>
          <div class="d-flex flex-column gap-2" style="min-width: 100px;">
            <div class="stat-pill clickable py-2 px-3 d-flex flex-column justify-content-center flex-fill text-center"
              data-tab-target="files">
              <small style="font-size: 0.65rem; opacity: 0.85;">Archivos</small>
              <div class="h5 mb-0" style="line-height: 1;">{{ files|length }}</div>
            </div>
            <div class="stat-pill clickable py-2 px-3 d-flex flex-column justify-content-center flex-fill text-center"
              data-tab-target="calendar">
              <small style="font-size: 0.65rem; opacity: 0.85;">Citas</small>
              <div class="h5 mb-0" style="line-height: 1;">{{ appointments|length }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="tab-content">
      <div class="tab-pane fade" id="summary" role="tabpanel">
        <div class="summary-grid" data-summary-panel data-workspace-slug="{{ current_workspace.schema_name if current_workspace else '' }}">
          <div class="summary-card">
            <div class="summary-card-body">
              <div class="summary-card-header">
                <div>
                  <div class="summary-title">Proximas citas</div>
                  <p class="summary-subtitle">Desde ahora en adelante</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis" data-summary-upcoming-count>
                    {{ appointments_upcoming|default(appointments)|length }}
                  </span>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-tab-target="calendar">Ver calendario</button>
                </div>
              </div>
              <div class="summary-list" data-summary-appointments-list>
                {% for c in appointments_upcoming|default(appointments) %}
                <div class="appointment-card" data-appointment-id="{{ c.id }}">
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <div class="app-title text-truncate" style="max-width: 220px;" title="{{ c.title }}">{{ c.title }}</div>
                      <span class="status-badge status-{{ c.status|default('programada') }}"
                        style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
                        {{ appointment_status_labels[c.status]|default(c.status|capitalize) }}
                      </span>
                    </div>
                    <div class="app-time">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      <span class="appointment-date opacity-0 transition-opacity" data-datetime="{{ c.start_time }}">{{
                        (c.start_time|string)[:10] }}</span>
                      <span class="text-muted mx-1">-</span>
                      <span class="appointment-hour opacity-0 transition-opacity" data-datetime="{{ c.start_time }}">{{
                        (c.start_time|string)[11:16] }}</span>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                  <div class="mb-2 opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                      <line x1="16" y1="2" x2="16" y2="6" />
                      <line x1="8" y1="2" x2="8" y2="6" />
                      <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                  </div>
                  <div class="small fw-semibold">Sin citas programadas</div>
                  <div class="small opacity-75">para este periodo</div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="summary-stack">
            <div class="summary-card">
              <div class="summary-card-body">
                <div class="summary-card-header">
                  <div>
                    <div class="summary-title">Resumen rapido</div>
                    <p class="summary-subtitle">Estado del workspace</p>
                  </div>
                </div>
                <div class="summary-kpis">
                  <div class="summary-kpi">
                    <div class="summary-kpi-label">Archivos</div>
                  <div class="summary-kpi-value">{{ files|length }}</div>
                </div>
                <div class="summary-kpi">
                  <div class="summary-kpi-label">Citas totales</div>
                  <div class="summary-kpi-value" data-summary-total-count>{{ appointments|length }}</div>
                </div>
                <div class="summary-kpi">
                  <div class="summary-kpi-label">Proximas</div>
                  <div class="summary-kpi-value" data-summary-upcoming-kpi>{{ appointments_upcoming|default(appointments)|length }}</div>
                </div>
                <div class="summary-kpi">
                  <div class="summary-kpi-label">Miembros</div>
                  <div class="summary-kpi-value">{{ workspace_members|length }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card-body">
                <div class="summary-card-header">
                  <div>
                    <div class="summary-title">Siguiente cita</div>
                    <p class="summary-subtitle">La mas cercana en agenda</p>
                  </div>
                </div>
                {% set next_appt = (appointments_upcoming|default(appointments))|first %}
                {% if next_appt %}
                <div class="summary-next" data-summary-next>
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="summary-next-name text-truncate" style="max-width: 220px;" title="{{ next_appt.title }}">
                      {{ next_appt.title }}
                    </div>
                    <span class="status-badge status-{{ next_appt.status|default('programada') }}"
                      style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
                      {{ appointment_status_labels[next_appt.status]|default(next_appt.status|capitalize) }}
                    </span>
                  </div>
                  <div class="app-time">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10" />
                      <polyline points="12 6 12 12 16 14" />
                    </svg>
                    <span class="appointment-date opacity-0 transition-opacity" data-datetime="{{ next_appt.start_time }}">{{
                      (next_appt.start_time|string)[:10] }}</span>
                    <span class="text-muted mx-1">-</span>
                    <span class="appointment-hour opacity-0 transition-opacity" data-datetime="{{ next_appt.start_time }}">{{
                      (next_appt.start_time|string)[11:16] }}</span>
                  </div>
                </div>
                {% else %}
                <div class="summary-next text-muted" data-summary-next>
                  No hay citas programadas por ahora.
                </div>
                {% endif %}
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-card-body">
                <div class="summary-card-header">
                  <div>
                    <div class="summary-title">Accesos rapidos</div>
                    <p class="summary-subtitle">Ir directo a cada area</p>
                  </div>
                </div>
                <div class="summary-actions">
                  <button class="summary-action" type="button" data-tab-target="calendar">Calendario</button>
                  <button class="summary-action" type="button" data-tab-target="files">Archivos</button>
                  <button class="summary-action" type="button" data-tab-target="clients">Gestionar clientes</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="files" role="tabpanel">
        {% include "partials/files_tab.html" %}
      </div>
      <div class="tab-pane fade show active" id="calendar" role="tabpanel">
        {% include "partials/calendar_tab.html" %}
      </div>
      <div class="tab-pane fade" id="clients" role="tabpanel">
        {% include "clientes.html" %}
      </div>
      <div class="tab-pane fade" id="whatsapp" role="tabpanel">
        {% include "partials/whatsapp_tab.html" %}
      </div>
    </div>
    {% else %}
    <div class="first-workspace-wrapper">
      <div class="first-workspace-card">
        <div class="first-workspace-copy">
          <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill mb-3 px-3 py-2">Nuevo usuario</span>
          <h2>Configura tu primer workspace</h2>
          <p class="text-muted">
            Un workspace agrupa tus archivos, agenda y miembros. Elige un nombre y un URL ?nico.
            Este formulario crear? la base de datos aislada y te a?adir? como propietario.
          </p>
          <ul class="text-muted small ps-3">
            <li>Puedes invitar a tu equipo luego desde el panel.</li>
            <li>El URL solo acepta letras, n?meros y guiones.</li>
            <li>Todo se crea autom?ticamente en PostgreSQL.</li>
          </ul>
        </div>
        <form method="POST" action="{{ url_for('ui.create_workspace_route') }}" class="d-flex flex-column gap-3"
          data-workspace-form>
          <div>
            <label class="form-label">Nombre del workspace</label>
            <input type="text" class="form-control form-control-lg" name="workspace_name"
              value="{{ current_user_name or '' }}" data-slug-source required placeholder="Control Vet">
          </div>
          <div>
            <label class="form-label">URL del workspace</label>
            <div class="input-group slug-input-group">
              <span class="input-group-text">app.vetflow.local/</span>
              <input type="text" class="form-control form-control-lg" name="workspace_slug" data-slug-field required
                placeholder="control-vet">
            </div>
            <div class="text-muted slug-helper mt-1">Sin espacios, se permiten letras min?sculas, n?meros y guiones.
            </div>
          </div>
          <div>
            <label class="form-label">Descripcion</label>
            <textarea class="form-control" name="workspace_description" rows="3"
              placeholder="Agenda conectada a RAG para mi cl?nica."></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Correo del propietario</label>
              <input type="email" class="form-control" name="owner_email" value="{{ current_user_email or '' }}"
                required placeholder="tu-correo@gmail.com">
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombre del propietario</label>
              <input type="text" class="form-control" name="owner_name" value="{{ current_user_name or '' }}"
                placeholder="Nombre completo">
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-lg mt-2">Crear workspace</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block modals %}
<!-- Modal de eventos del dia -->
<div class="modal fade" id="dayEventsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayEventsTitle">Citas del dia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="dayEventsBody">
      </div>
    </div>
  </div>
</div>

<!-- Modal crear/editar cita rapida -->
<div class="modal fade quick-event-modal" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
    <div class="modal-content shadow quick-event-card">
      <div class="modal-header border-0 pb-0">

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createEventForm" class="quick-event-form">
        <div class="modal-body pt-0">
          <input type="text" class="form-control form-control-lg quick-event-title" id="eventTitleInput"
            placeholder="Agregar titulo" required>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="8" />
                <path d="M12 8v4l3 1.8" />
              </svg>
            </div>
            <div class="quick-event-datetime">
              <input type="datetime-local" class="form-control" id="eventStartInput" required>
              <span class="quick-event-separator">a</span>
              <input type="datetime-local" class="form-control" id="eventEndInput" required>
            </div>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 4h7l5 5v11H8z" />
                <path d="M15 4v5h5" />
                <path d="M11 14h7" />
                <path d="M11 18h7" />
              </svg>
            </div>
            <textarea class="form-control" id="eventDescInput" rows="2"
              placeholder="Agregar descripcion o notas"></textarea>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="7" />
                <circle cx="12" cy="12" r="3" />
                <path d="M12 5v2" />
                <path d="M12 17v2" />
                <path d="M5 12h2" />
                <path d="M17 12h2" />
              </svg>
            </div>
            <select class="form-select" id="eventStatusSelect">
              {% for status in appointment_statuses %}
              <option value="{{ status.value }}">{{ status.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0" />
                <circle cx="12" cy="9" r="4" />
              </svg>
            </div>
            <select class="form-select" id="eventClientSelect">
              <option value="">Cliente (opcional)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0 flex-column flex-sm-row gap-2 justify-content-between align-items-start">
          <div class="text-muted small" id="eventRangeLabel"></div>
          <div class="d-flex gap-2 w-100 justify-content-sm-end">
            <button type="button" class="btn btn-light flex-fill flex-sm-grow-0"
              data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0">Crear</button>
          </div>
        </div>
        <input type="hidden" id="eventStartIso">
        <input type="hidden" id="eventEndIso">
      </form>
    </div>
  </div>
</div>

<!-- Modal crear workspace -->
<div class="modal fade" id="createWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('ui.create_workspace_route') }}" data-workspace-form>
        <div class="modal-header">
          <h5 class="modal-title">Nuevo workspace</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre del workspace</label>
            <input type="text" class="form-control" name="workspace_name" required placeholder="Control Vet"
              data-slug-source>
          </div>
          <div class="mb-3">
            <label class="form-label">URL del workspace</label>
            <div class="input-group slug-input-group">
              <span class="input-group-text">app.vetflow.local/</span>
              <input type="text" class="form-control" name="workspace_slug" placeholder="control-vet" data-slug-field>
            </div>
            <small class="text-muted">Solo letras minúsculas, números y guiones.</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripcion</label>
            <textarea class="form-control" name="workspace_description" rows="2"
              placeholder="Uso interno del equipo"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo del propietario (Gmail)</label>
            <input type="email" class="form-control" name="owner_email" required placeholder="owner@example.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Nombre del propietario</label>
            <input type="text" class="form-control" name="owner_name" placeholder="Nombre completo">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear workspace</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal invitar a workspace -->
<div class="modal fade" id="inviteWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="inviteWorkspaceForm"
        data-workspace-slug="{{ current_workspace.schema_name if current_workspace else '' }}">
        <div class="modal-header">
          <h5 class="modal-title">Invitar a workspace</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Correo de la persona</label>
            <input type="email" class="form-control" name="invite_email" required placeholder="equipo@clinica.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Duracion del enlace (dias, opcional)</label>
            <input type="number" class="form-control" name="invite_expires" min="0" max="365"
              placeholder="Sin vencimiento">
            <div class="form-text">Deja vacio o 0 para que no expire.</div>
          </div>
          <div class="alert alert-info small mb-2">
            Generamos un codigo unico y lo guardamos en la base. Copialo y compartelo por correo/chat.
          </div>
          <div class="small fw-semibold" id="inviteWorkspaceStatus"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Enviar invitacion</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal aceptar invitacion -->
<div class="modal fade" id="acceptInviteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="acceptInviteForm">
        <div class="modal-header">
          <h5 class="modal-title">Unirme con codigo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Codigo</label>
            <input type="text" class="form-control" name="invite_code" required placeholder="ej. 1mJ5W2Gc">
          </div>
          <div class="mb-3">
            <label class="form-label">Tu correo</label>
            <input type="email" class="form-control" name="invite_email" required placeholder="tu-correo@clinica.com"
              value="{{ current_user_email or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Tu nombre (opcional)</label>
            <input type="text" class="form-control" name="invite_name" placeholder="Nombre completo"
              value="{{ current_user_name or '' }}">
          </div>
          <div class="alert alert-info small mb-2">
            Usaremos el codigo para agregarte al workspace. Si es correcto, te redirigimos al panel.
          </div>
          <div class="small fw-semibold" id="acceptInviteStatus"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Unirme</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal miembros workspace -->
<div class="modal fade" id="membersWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Miembros del workspace</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if workspace_members %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Correo</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Ingreso</th>
                {% if current_membership_role == 'owner' %}<th></th>{% endif %}
              </tr>
            </thead>
            <tbody>
              {% for m in workspace_members %}
              <tr>
                <td>{{ m.email }}</td>
                <td>{{ m.display_name or 'Sin nombre' }}</td>
                <td>
                  <span
                    class="badge {% if m.role == 'owner' %}bg-primary{% elif m.role == 'admin' %}bg-info{% else %}bg-secondary{% endif %}">
                    {{ m.role|capitalize }}
                  </span>
                </td>
                <td class="text-muted small">{{ m.joined_at }}</td>
                {% if current_membership_role == 'owner' %}
                <td class="text-end">
                  {% if m.role != 'owner' %}
                  <button class="btn btn-sm btn-outline-danger" type="button" data-remove-member
                    data-member-email="{{ m.email }}">Quitar</button>
                  {% endif %}
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-light mb-0">
          No hay miembros cargados para este workspace.
        </div>
        {% endif %}
        <div id="membersRemoveStatus" class="small fw-semibold mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal eliminar workspace -->
<div class="modal fade" id="deleteWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">Eliminar workspace</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('ui.delete_workspace_route') }}" id="deleteWorkspaceForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Selecciona el workspace a eliminar</label>
            <select class="form-select" name="workspace_id" id="deleteWorkspaceSelect" required>
              <option value="" disabled selected>Elige workspace</option>
              {% for ws in workspaces %}
              <option value="{{ ws.id }}">{{ ws.name }} ({{ ws.slug }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="alert alert-warning">
            <div class="fw-bold">Si eliminas este workspace se perderá toda la información (archivos y citas).</div>
            <div>Escribe exactamente: <code>eliminar esta area trabajo</code> para confirmar.</div>
          </div>
          <div class="mb-2">
            <label class="form-label">Confirmación</label>
            <input type="text" class="form-control" name="confirmation_phrase" id="deleteWorkspacePhrase"
              placeholder="eliminar esta area trabajo" autocomplete="off" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger" id="deleteWorkspaceSubmit" disabled>Eliminar
            definitivamente</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.vetflowData = {
    appointments: {{ appointments | tojson }}
  };
  window.vetflowStatuses = {{ appointment_statuses | tojson }};
  window.vetflowStatusLabels = {{ appointment_status_labels | tojson }};
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="{{ url_for('static', filename='js/calendar.js') }}?v=12"></script>
<script src="{{ url_for('static', filename='js/fullcalendar.js') }}?v=11"></script>
<script src="{{ url_for('static', filename='js/whatsapp.js') }}?v=26"></script>
<script src="{{ url_for('static', filename='js/clientes.js') }}?v=2"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.__renderCalendar) {
      try { window.__renderCalendar(); } catch (err) { console.warn('Legacy calendar render error', err); }
    }

    const sideNav = document.getElementById('sideNav');
    const sideOverlay = document.getElementById('sideOverlay');
    const toggleSide = (open) => {
      const shouldOpen = typeof open === 'boolean' ? open : sideNav?.classList.contains('collapsed');
      if (shouldOpen) {
        sideNav?.classList.remove('collapsed');
        sideOverlay?.classList.add('open');
      } else {
        sideNav?.classList.add('collapsed');
        sideOverlay?.classList.remove('open');
      }
    };
    document.getElementById('toggleSideNav')?.addEventListener('click', () => toggleSide());
    sideOverlay?.addEventListener('click', () => toggleSide(false));

    const setActiveTab = (target) => {
      document.querySelectorAll('.side-link').forEach((btn) => btn.classList.toggle('active', btn.dataset.tabTarget === target));
      document.querySelectorAll('.tab-pane').forEach((pane) => {
        pane.classList.remove('show', 'active');
        if (pane.id === target) pane.classList.add('show', 'active');
      });
      document.body?.setAttribute('data-active-tab', target);
      if (target === 'calendar' && window.__renderCalendar) {
        try { window.__renderCalendar(); } catch (e) { console.error(e); }
      }
      if (target === 'calendar') {
        window.dispatchEvent(new Event('vetflow:calendarTabActivated'));
      }
      localStorage.setItem('vetflow_active_tab', target);
    };

    document.querySelectorAll('[data-tab-target]').forEach((el) => {
      el.addEventListener('click', () => {
        const target = el.getAttribute('data-tab-target');
        setActiveTab(target);
        toggleSide(false);
      });
    });

    const calendarTab = document.getElementById('calendar');
    const summaryTab = document.getElementById('summary');
    const defaultTab = calendarTab ? 'calendar' : (summaryTab ? 'summary' : 'calendar');
    const savedTab = localStorage.getItem('vetflow_active_tab');
    const savedTabExists = savedTab && document.getElementById(savedTab);
    setActiveTab(savedTabExists ? savedTab : defaultTab);

    // arrancamos colapsado en desktop; en mobile se abre con el overlay
    toggleSide(false);
  });
</script>
<script>
  (() => {
    const panel = document.querySelector('[data-summary-panel]');
    if (!panel) return;

    const slug = panel.getAttribute('data-workspace-slug') || '';
    const apiBase = slug ? `/w/${encodeURIComponent(slug)}/api/calendar` : '/api/calendar';
    const listEl = panel.querySelector('[data-summary-appointments-list]');
    const countEl = panel.querySelector('[data-summary-upcoming-count]');
    const totalEl = panel.querySelector('[data-summary-total-count]');
    const upcomingEl = panel.querySelector('[data-summary-upcoming-kpi]');
    const nextEl = panel.querySelector('[data-summary-next]');
    const refreshMs = 2000;
    let refreshTimer = null;
    let hasLoaded = false;
    let previousIds = new Set();
    const soundUrl = "{{ url_for('static', filename='music/ta-da_yrvBrlS.mp3') }}";
    const summarySound = new Audio(soundUrl);
    summarySound.preload = 'auto';
    summarySound.volume = 0.7;
    let soundUnlocked = false;
    let soundPending = false;

    const playSound = () => {
      if (!soundUnlocked) {
        soundPending = true;
        return;
      }
      try {
        summarySound.currentTime = 0;
        const playPromise = summarySound.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch(() => { });
        }
      } catch { }
    };

    const unlockSound = () => {
      if (soundUnlocked) return;
      soundUnlocked = true;
      if (soundPending) {
        soundPending = false;
        playSound();
      }
    };

    document.addEventListener('pointerdown', unlockSound, { once: true });
    document.addEventListener('keydown', unlockSound, { once: true });
    document.addEventListener('touchstart', unlockSound, { once: true });

    const pad2 = (n) => String(n).padStart(2, '0');
    const formatDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    const formatTime = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const parseDate = (value) => {
      if (!value) return null;
      const d = new Date(value);
      return Number.isNaN(d.getTime()) ? null : d;
    };
    const escapeHtml = (value) =>
      String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const statusLabel = (status) => {
      const labels = window.vetflowStatusLabels || {};
      const key = String(status || 'programada').toLowerCase();
      const fallback = key ? `${key.charAt(0).toUpperCase()}${key.slice(1)}` : 'Programada';
      return labels[key] || fallback;
    };

    const emptyHtml = `
      <div class="text-center text-muted py-5">
        <div class="mb-2 opacity-50">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        </div>
        <div class="small fw-semibold">Sin citas programadas</div>
        <div class="small opacity-75">para este periodo</div>
      </div>
    `;

    const renderAppointment = (appt) => {
      const title = escapeHtml(appt.title || '(Sin titulo)');
      const status = String(appt.status || 'programada').toLowerCase();
      const label = escapeHtml(statusLabel(status));
      const start = appt.startDate || appt.endDate || null;
      const dateText = start ? formatDate(start) : '--';
      const timeText = start ? formatTime(start) : '--:--';
      const datetime = escapeHtml(appt.start_time || appt.end_time || '');

      return `
        <div class="appointment-card" data-appointment-id="${escapeHtml(appt.id)}">
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div class="app-title text-truncate" style="max-width: 220px;" title="${title}">${title}</div>
              <span class="status-badge status-${status}" style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
                ${label}
              </span>
            </div>
            <div class="app-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              <span class="appointment-date" data-datetime="${datetime}">${dateText}</span>
              <span class="text-muted mx-1">-</span>
              <span class="appointment-hour" data-datetime="${datetime}">${timeText}</span>
            </div>
          </div>
        </div>
      `;
    };

    const renderNext = (appt) => {
      if (!nextEl) return;
      if (!appt) {
        nextEl.classList.add('text-muted');
        nextEl.innerHTML = 'No hay citas programadas por ahora.';
        return;
      }
      nextEl.classList.remove('text-muted');
      const title = escapeHtml(appt.title || '(Sin titulo)');
      const status = String(appt.status || 'programada').toLowerCase();
      const label = escapeHtml(statusLabel(status));
      const start = appt.startDate || appt.endDate || null;
      const dateText = start ? formatDate(start) : '--';
      const timeText = start ? formatTime(start) : '--:--';
      const datetime = escapeHtml(appt.start_time || appt.end_time || '');
      nextEl.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="summary-next-name text-truncate" style="max-width: 220px;" title="${title}">${title}</div>
          <span class="status-badge status-${status}" style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
            ${label}
          </span>
        </div>
        <div class="app-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          <span class="appointment-date" data-datetime="${datetime}">${dateText}</span>
          <span class="text-muted mx-1">-</span>
          <span class="appointment-hour" data-datetime="${datetime}">${timeText}</span>
        </div>
      `;
    };

    const updateCounts = (total, upcoming) => {
      if (countEl) countEl.textContent = String(upcoming);
      if (totalEl) totalEl.textContent = String(total);
      if (upcomingEl) upcomingEl.textContent = String(upcoming);
    };

    const refreshSummary = async () => {
      try {
        const res = await fetch(apiBase, { headers: { Accept: 'application/json' }, cache: 'no-store' });
        const data = await res.json().catch(() => []);
        if (!res.ok) return;
        const items = Array.isArray(data) ? data : [];
        const nowTs = Date.now();
        const withDates = items.map((appt) => {
          const startDate = parseDate(appt.start_time);
          const endDate = parseDate(appt.end_time);
          const startTs = startDate ? startDate.getTime() : null;
          const endTs = endDate ? endDate.getTime() : null;
          const bestTs = Math.max(startTs ?? -Infinity, endTs ?? -Infinity);
          return { ...appt, startDate, endDate, startTs, endTs, bestTs };
        });
        const upcoming = withDates
          .filter((appt) => Number.isFinite(appt.bestTs) && appt.bestTs >= nowTs)
          .sort((a, b) => (a.startTs ?? a.bestTs) - (b.startTs ?? b.bestTs));

        updateCounts(items.length, upcoming.length);

        const visibleUpcoming = upcoming.slice(0, 50);
        if (listEl) {
          if (!visibleUpcoming.length) {
            listEl.innerHTML = emptyHtml;
          } else {
            listEl.innerHTML = visibleUpcoming.map(renderAppointment).join('');
          }
        }
        renderNext(visibleUpcoming[0]);

        const nextIds = new Set(
          visibleUpcoming
            .map((appt) => String(appt.id ?? '').trim())
            .filter((id) => id.length)
        );
        if (hasLoaded) {
          let hasNew = false;
          nextIds.forEach((id) => {
            if (!previousIds.has(id)) hasNew = true;
          });
          if (hasNew) playSound();
        } else {
          hasLoaded = true;
        }
        previousIds = nextIds;
      } catch (err) {
        console.warn('Summary refresh failed', err);
      }
    };

    const startRefreshLoop = () => {
      if (refreshTimer) return;
      refreshTimer = setInterval(refreshSummary, refreshMs);
    };

    const openDetail = async (appointmentId) => {
      if (!appointmentId) return;
      try {
        const url = `${apiBase}/${encodeURIComponent(appointmentId)}`;
        const res = await fetch(url, { headers: { Accept: 'application/json' }, cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return;
        const startDate = parseDate(data.start_time);
        const endDate = parseDate(data.end_time);
        const eventPayload = {
          id: data.id,
          title: data.title,
          description: data.description || '',
          status: data.status || 'programada',
          start: startDate,
          end: endDate,
          client_id: data.client_id ?? null,
        };
        if (window.vetflowCalendar?.openEventModal) {
          window.vetflowCalendar.openEventModal(eventPayload);
          return;
        }
        if (typeof window.openEdit === 'function') {
          window.openEdit(
            Number(eventPayload.id),
            String(eventPayload.title || ''),
            String(eventPayload.description || ''),
            data.start_time || '',
            data.end_time || '',
            String(eventPayload.status || 'programada'),
            eventPayload.client_id
          );
        }
      } catch (err) {
        console.warn('No se pudo abrir detalle de cita', err);
      }
    };

    const init = () => {
      refreshSummary();
      startRefreshLoop();
      if (listEl) {
        listEl.addEventListener('click', (event) => {
          const card = event.target.closest('.appointment-card');
          if (!card || !listEl.contains(card)) return;
          const id = card.getAttribute('data-appointment-id');
          if (!id) return;
          openDetail(id);
        });
      }
      document.querySelectorAll('[data-tab-target="summary"]').forEach((btn) => {
        btn.addEventListener('click', refreshSummary);
      });
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) refreshSummary();
      });
      window.addEventListener('vetflow:calendarChanged', refreshSummary);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
<script>
  (() => {
    const fetchSasUrl = async (fileId) => {
      const res = await fetch(`/file/${fileId}/sas`, {
        headers: {
          'Accept': 'application/json'
        }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || `Error ${res.status}`);
      }
      if (!data.url) {
        throw new Error('Respuesta sin URL SAS');
      }
      return data.url;
    };

    window.openFile = async (fileId) => {
      if (!fileId) {
        console.warn('openFile llamado sin id');
        return;
      }
      const previewWindow = window.open('', '_blank');
      if (previewWindow && previewWindow.document) {
        previewWindow.document.body.innerHTML = '<div style="font-family:system-ui,sans-serif;padding:16px;">Abriendo archivo...</div>';
      }
      try {
        const sasUrl = await fetchSasUrl(fileId);
        if (previewWindow) {
          previewWindow.location = sasUrl;
        } else {
          window.open(sasUrl, '_blank', 'noopener');
        }
      } catch (err) {
        if (previewWindow && !previewWindow.closed) {
          previewWindow.close();
        }
        console.error('No se pudo abrir el archivo', err);
        const msg = err && err.message ? err.message : 'No se pudo generar el enlace SAS';
        alert(`No se pudo abrir el archivo: ${msg}`);
      }
    };
  })();
</script>
<script>
  (() => {
    // Toggle panel de citas sin que se mueva el layout
    // const toggleBtn = document.querySelector('[data-appointments-toggle]');
    // const panel = document.querySelector('[data-appointments-panel]');
    // if (toggleBtn && panel) {
    //   const syncState = () => {
    //     const isHidden = panel.classList.contains('hidden-panel');
    //     toggleBtn.setAttribute('aria-expanded', String(!isHidden));
    //   };
    //   toggleBtn.addEventListener('click', () => {
    //     panel.classList.toggle('hidden-panel');
    //     syncState();
    //   });
    //   syncState();
    // }
  })();
</script>
<script>
  (() => {
    // Confirmación de borrado de workspace
    const phraseInput = document.getElementById('deleteWorkspacePhrase');
    const selectInput = document.getElementById('deleteWorkspaceSelect');
    const submitBtn = document.getElementById('deleteWorkspaceSubmit');
    const requiredPhrase = 'eliminar esta area trabajo';

    const validate = () => {
      const phraseOk = (phraseInput?.value || '').trim().toLowerCase() === requiredPhrase;
      const wsOk = !!(selectInput && selectInput.value);
      if (submitBtn) {
        submitBtn.disabled = !(phraseOk && wsOk);
      }
    };

    phraseInput?.addEventListener('input', validate);
    selectInput?.addEventListener('change', validate);
    validate();
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('inviteWorkspaceForm');
    if (!form) return;
    const statusEl = document.getElementById('inviteWorkspaceStatus');
    const submitBtn = form.querySelector('[type="submit"]');
    const emailInput = form.querySelector('input[name="invite_email"]');
    const expiresInput = form.querySelector('input[name="invite_expires"]');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const resetForm = () => {
      form.reset();
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar invitacion';
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('', null);
      const slug = form.dataset.workspaceSlug;
      const email = (emailInput?.value || '').trim();
      const expiresRaw = expiresInput?.value;
      if (!slug) {
        setStatus('Selecciona un workspace antes de invitar.', 'error');
        return;
      }
      if (!email) {
        setStatus('Ingresa un correo', 'error');
        return;
      }
      const payload = { email };
      if (expiresRaw !== undefined && expiresRaw !== '') {
        payload.expires_in_days = Number(expiresRaw);
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }

      try {
        const res = await fetch(`/w/${slug}/api/invites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || `Error ${res.status}`);
        }
        const code = data?.invite?.invite_code ? ` Codigo: ${data.invite.invite_code}` : '';
        setStatus(`Invitacion creada.${code}`, 'success');
        form.reset();
      } catch (err) {
        setStatus(err?.message || 'No se pudo crear la invitacion', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar invitacion';
        }
      }
    });

    const modalEl = document.getElementById('inviteWorkspaceModal');
    if (modalEl) {
      modalEl.addEventListener('hidden.bs.modal', resetForm);
    }
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('acceptInviteForm');
    if (!form) return;
    const statusEl = document.getElementById('acceptInviteStatus');
    const submitBtn = form.querySelector('[type="submit"]');
    const codeInput = form.querySelector('input[name="invite_code"]');
    const emailInput = form.querySelector('input[name="invite_email"]');
    const nameInput = form.querySelector('input[name="invite_name"]');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const resetForm = () => {
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Unirme';
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = (codeInput?.value || '').trim();
      const email = (emailInput?.value || '').trim();
      const name = (nameInput?.value || '').trim();
      if (!code || !email) {
        setStatus('Ingresa codigo y correo', 'error');
        return;
      }
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }
      try {
        const res = await fetch('/api/invites/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, email, name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || `Error ${res.status}`);
        }
        const slug = data?.workspace?.schema_name || data?.workspace?.slug;
        setStatus('Invitacion aceptada. Redirigiendo...', 'success');
        if (slug) {
          setTimeout(() => { window.location = `/w/${slug}`; }, 500);
        } else {
          setTimeout(() => { window.location.reload(); }, 500);
        }
      } catch (err) {
        setStatus(err?.message || 'No se pudo aceptar la invitacion', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Unirme';
        }
      }
    });

    const modalEl = document.getElementById('acceptInviteModal');
    if (modalEl) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        form.reset();
        resetForm();
      });
    }
  })();
</script>
<script>
  (() => {
    const removeButtons = document.querySelectorAll('[data-remove-member]');
    if (!removeButtons.length) return;
    const statusEl = document.getElementById('membersRemoveStatus');
    const workspaceSlug = "{{ current_workspace.schema_name if current_workspace else '' }}";

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    removeButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const email = btn.getAttribute('data-member-email');
        if (!workspaceSlug || !email) return;
        if (!confirm(`¿Quitar a ${email} del workspace?`)) return;
        btn.disabled = true;
        setStatus('', null);
        try {
          const res = await fetch(`/w/${workspaceSlug}/api/members/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data.error || `Error ${res.status}`);
          }
          setStatus('Miembro removido. Recargando...', 'success');
          setTimeout(() => window.location.reload(), 500);
        } catch (err) {
          setStatus(err?.message || 'No se pudo remover', 'error');
        } finally {
          btn.disabled = false;
        }
      });
    });
  })();
</script>
<script>
  (() => {
    const slugify = (value) =>
      String(value || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 48);

    const attachSlugSync = (form) => {
      const nameInput = form.querySelector('[data-slug-source]');
      const slugInput = form.querySelector('[data-slug-field]');
      if (!nameInput || !slugInput) return;
      let slugTouched = slugInput.value.trim().length > 0;

      const setSlugValue = (value) => {
        const next = slugify(value);
        slugInput.value = next;
      };

      nameInput.addEventListener('input', () => {
        if (slugTouched) return;
        setSlugValue(nameInput.value);
      });

      slugInput.addEventListener('input', () => {
        slugTouched = slugInput.value.trim().length > 0;
        setSlugValue(slugInput.value);
      });

      if (!slugTouched) {
        setSlugValue(nameInput.value || slugInput.value);
      }
    };

    document.querySelectorAll('[data-workspace-form]').forEach(attachSlugSync);
  })();
</script>
<script>
  (() => {
    // Drag and Drop para archivos
    const dropZone = document.getElementById('filesDropZone');
    const overlay = document.getElementById('filesDropOverlay');
    const fileInput = document.getElementById('fileInput');
    const uploadDrawer = document.getElementById('uploadDrawer');
    const label = document.getElementById('selectedFilesLabel');

    if (!dropZone || !overlay || !fileInput) return;

    // Prevent defaults globalmente para evitar que el navegador abra el archivo
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Detectar drag sobre todo el documento para mostrar overlay
    let dragCounter = 0;
    document.body.addEventListener('dragenter', (e) => {
      dragCounter++;
      if (dragCounter === 1) {
        overlay.classList.add('active');
        // Asegurar que estamos en la tab de archivos si no lo estamos? 
        // Por ahora asumimos que solo importa si el usuario quiere soltar.
      }
    });

    document.body.addEventListener('dragleave', (e) => {
      dragCounter--;
      if (dragCounter === 0) {
        overlay.classList.remove('active');
      }
    });

    document.body.addEventListener('drop', (e) => {
      dragCounter = 0;
      overlay.classList.remove('active');

      const dt = e.dataTransfer;
      const files = dt.files;

      if (files && files.length > 0) {
        // Asignar archivos al input
        fileInput.files = files;

        // Actualizar etiqueta
        if (label) {
          label.textContent = files.length + ' archivo(s) seleccionados para subir';
        }

        // Abrir el drawer si está cerrado
        if (uploadDrawer && !uploadDrawer.classList.contains('show')) {
          // Usar Bootstrap API si está disponible o fallback manual
          // Si tenemos bootstrap global:
          try {
            const bsCollapse = new bootstrap.Collapse(uploadDrawer, { show: true });
          } catch (err) {
            // Fallback simple por si bootstrap no esta en window
            uploadDrawer.classList.add('show');
          }
        }

        // Hacemos scroll suave hacia el formulario
        uploadDrawer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('textUploadForm');
    if (!form) return;

    const titleInput = document.getElementById('textNoteTitle');
    const tagsInput = document.getElementById('textNoteTags');
    const notesInput = document.getElementById('textNoteNotes');
    const contentInput = document.getElementById('textNoteContent');
    const statusEl = document.getElementById('textNoteStatus');
    const submitBtn = document.getElementById('textNoteSubmit');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const safeFilename = (value) =>
      String(value || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9_-]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 48)
        .toLowerCase();

    const timestampSuffix = () => {
      const now = new Date();
      const pad = (num) => String(num).padStart(2, '0');
      return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const content = (contentInput?.value || '').trim();
      if (!content) {
        setStatus('Escribe una nota antes de subir.', 'error');
        contentInput?.focus();
        return;
      }

      const rawTitle = (titleInput?.value || '').trim();
      const safeTitle = safeFilename(rawTitle);
      const filename = safeTitle ? `${safeTitle}.txt` : `nota-${timestampSuffix()}.txt`;

      const file = new File([content], filename, { type: 'text/plain' });
      const formData = new FormData();
      formData.append('file', file);

      const tags = (tagsInput?.value || '').trim();
      const notes = (notesInput?.value || '').trim();
      if (tags) formData.append('tags', tags);
      if (notes) formData.append('notes', notes);

      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subiendo...';
      }

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        if (!res.ok) {
          throw new Error(`Error ${res.status}`);
        }
        setStatus('Nota creada. Recargando...', 'success');
        form.reset();
        setTimeout(() => window.location.reload(), 600);
      } catch (err) {
        setStatus('No se pudo subir la nota.', 'error');
        console.error('Error subiendo nota', err);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear TXT';
        }
      }
    });
  })();
</script>
{% endblock %}
