{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

{% if current_workspace and current_workspace.theme_color %}
<style>
  :root {
    --vet-primary: {
        {
        current_workspace.theme_color or '#6c47ff'
      }
    }

    ;

    --vet-primary-rgb: {
        {
        (current_workspace.theme_color or '#6c47ff') | hex_to_rgb
      }
    }

    ;
    --vet-primary-hover: color-mix(in srgb, var(--vet-primary), black 10%);
    --vet-primary-strong: color-mix(in srgb, var(--vet-primary), black 20%);
    --vet-primary-subtle: color-mix(in srgb, var(--vet-primary), transparent 94%);

    /* Tokens */
    --vet-radius-xl: 24px;
    --vet-radius-lg: 18px;
    --vet-radius-md: 12px;
    --vet-shadow-sm: 0 10px 40px rgba(15, 23, 42, 0.08);
    --vet-shadow-md: 0 15px 40px rgba(15, 23, 42, 0.12);
    --vet-shadow-lg: 0 20px 25px -5px rgba(15, 23, 42, 0.15);
    --vet-glass-bg: rgba(255, 255, 255, 0.7);
    --vet-glass-border: rgba(255, 255, 255, 0.5);

    /* Backgrounds */
    --vet-bg-app: #f5f0ff;
    --vet-bg-surface: #ffffff;
    --vet-bg-subtle: #f8f5ff;
    --vet-border: color-mix(in srgb, var(--vet-primary), transparent 85%);
    --vet-border-light: color-mix(in srgb, var(--vet-primary), transparent 92%);
    --vet-text-main: #1c1233;
    --vet-text-secondary: #4b5563;
    --vet-text-muted: #8b7ccf;

    /* Bootstrap */
    --bs-primary: var(--vet-primary);
    --bs-primary-rgb: var(--vet-primary-rgb);
    --bs-link-color: var(--vet-primary);
    --bs-border-radius-lg: var(--vet-radius-md);
  }

  [data-theme="dark"] {
    --vet-primary: color-mix(in srgb, {
        {
        current_workspace.theme_color or '#6c47ff'
      }
    }

    , white 15%);
  --vet-bg-app: #0b0f19;
  --vet-bg-surface: #151b2b;
  --vet-bg-subtle: #1e2538;
  --vet-glass-bg: rgba(21, 27, 43, 0.75);
  --vet-glass-border: rgba(255, 255, 255, 0.1);
  --vet-border: #2d3748;
  --vet-border-light: rgba(255, 255, 255, 0.12);
  --vet-text-main: #f3f4f6;
  --vet-text-secondary: #d1d5db;
  --vet-text-muted: #9ca3af;
  }
</style>
{% endif %}

<style>
  body {
    background-color: var(--vet-bg-app);
    font-family: 'Manrope', 'Segoe UI', system-ui, sans-serif;
    color: var(--vet-text-main);
  }

  /* COLOR PICKER INDICATOR */
  .btn-check:checked+label.rounded-circle {
    box-shadow: 0 0 0 3px var(--vet-bg-surface), 0 0 0 6px var(--vet-primary) !important;
    transform: scale(1.15) !important;
    z-index: 2;
  }

  .btn-check+label.rounded-circle {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    border: 2px solid #fff !important;
    outline: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  .btn-check+label.rounded-circle:hover {
    transform: scale(1.1);
  }

  /* CALENDAR RESIZER */
  .calendar-resizer-handle {
    width: 8px;
    cursor: col-resize;
    background: transparent;
    transition: all 0.2s;
    z-index: 100;
    margin: 0 -4px;
    border-radius: 4px;
    display: none;
  }

  .calendar-resizer-handle:hover,
  .calendar-resizer-handle.resizing {
    background: var(--vet-primary);
    opacity: 0.2;
    width: 12px;
    margin: 0 -6px;
  }

  @media (min-width: 992px) {
    .calendar-resizer-handle {
      display: block;
    }
  }

  /* SIDE NAV */
  .side-nav {
    width: 280px;
    background: var(--vet-glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--vet-glass-border);
    border-radius: var(--vet-radius-xl);
    padding: 1.5rem 1rem;
    box-shadow: var(--vet-shadow-lg);
    position: fixed;
    top: 100px;
    left: 20px;
    height: calc(100vh - 120px);
    z-index: 1050;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    overflow-y: auto;
  }

  .side-nav.collapsed {
    transform: translateX(-340px);
    opacity: 0;
    pointer-events: none;
  }

  .side-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 43, 0.25);
    backdrop-filter: blur(4px);
    z-index: 1040;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .side-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }

  .side-section-title {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--vet-text-muted);
    margin: 1.5rem 0 0.5rem 0.75rem;
    opacity: 0.8;
  }

  .side-link {
    width: 100%;
    border: 0;
    background: transparent;
    padding: 0.8rem 1rem;
    border-radius: var(--vet-radius-md);
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--vet-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.85rem;
    transition: all 0.2s ease;
    text-decoration: none !important;
  }

  .side-link:hover {
    background: var(--vet-bg-subtle);
    color: var(--vet-primary);
    transform: translateX(4px);
  }

  .side-link.active {
    background: var(--vet-primary);
    color: #fff !important;
    box-shadow: 0 8px 25px -5px color-mix(in srgb, var(--vet-primary), transparent 30%);
  }

  .side-link svg {
    width: 20px;
    height: 20px;
  }

  /* CONTENT AREA */
  .main-content-wrapper {
    flex-grow: 1;
    padding: 1.5rem 1rem;
    min-width: 0;
    max-width: 100%;
    width: 100%;
    transition: opacity 0.3s ease;
  }

  @media (max-width: 992px) {
    .main-content-wrapper {
      padding: 1.5rem;
    }
  }

  /* HAMBURGER BUTTON IN NAVBAR */
  .hamburger-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border: 1px solid var(--vet-border-light);
    background: var(--vet-bg-surface);
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.4rem;
    color: var(--vet-primary);
    transition: all 0.2s ease;
    box-shadow: var(--vet-shadow-sm);
  }

  .hamburger-toggle:hover {
    background: var(--vet-bg-subtle);
    transform: scale(1.05);
  }

  .brand-hero {
    background: linear-gradient(135deg, var(--vet-primary) 0%, var(--vet-primary-strong) 100%);
    border-radius: 24px;
    color: #fff;
    padding: 3rem 3.5rem;
    box-shadow: var(--vet-shadow-lg);
    position: relative;
    overflow: hidden;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 3rem;
  }

  .hero-content-left {
    display: flex;
    align-items: center;
    gap: 3rem;
    flex: 1;
    min-width: 0;
  }

  .hero-content-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2rem;
    flex-shrink: 0;
  }

  @media (max-width: 992px) {
    .brand-hero {
      flex-direction: column;
      text-align: center;
      padding: 3rem 2rem;
      gap: 2rem;
    }

    .hero-content-left {
      flex-direction: column;
      gap: 1.5rem;
      text-align: center;
    }

    .hero-info-text,
    .hero-info-text h1,
    .hero-info-text p {
      text-align: center !important;
    }

    .hero-content-right {
      align-items: center;
    }
  }

  /* ULTRA-MOBILE OPTIMIZATION (500x400) */
  @media (max-width: 500px),
  (max-height: 450px) {

    .vetflow-nav {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 60px !important;
      height: 60px !important;
      z-index: 9999 !important;
      padding: 0 !important;
    }

    .vetflow-nav .vetflow-brand,
    .vetflow-nav .vetflow-session {
      display: none !important;
    }

    .hamburger-toggle {
      display: flex !important;
      position: fixed !important;
      top: 10px !important;
      left: 10px !important;
      z-index: 9999 !important;
      background: var(--vet-bg-surface) !important;
      border: 1px solid var(--vet-border-light) !important;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
      pointer-events: auto !important;
      width: 42px !important;
      height: 42px !important;
    }

    .brand-hero {
      display: none !important;
    }

    .side-nav {
      top: 0 !important;
      left: 0 !important;
      height: 100vh !important;
      border-radius: 0 !important;
      width: 280px !important;
      z-index: 10000 !important;
      /* Higher than toggle button */
      display: flex !important;
      transition: transform 0.4s ease !important;
    }

    .side-nav.collapsed {
      transform: translateX(-100%) !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .side-overlay {
      display: block !important;
      z-index: 9998 !important;
    }

    .side-overlay:not(.open) {
      display: none !important;
      opacity: 0 !important;
    }

    .app-shell {
      padding-top: 0 !important;
    }

    #app-shell-content {
      padding: 0 !important;
    }

    .main-content-wrapper {
      padding: 0 !important;
      margin: 0 !important;
      max-width: 100% !important;
      width: 100% !important;
    }

    .summary-grid {
      grid-template-columns: 1fr !important;
      display: block !important;
      gap: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* Hide secondary card (Quick Access/Stats) */
    .summary-grid>div:nth-child(2) {
      display: none !important;
    }

    .summary-card {
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
      height: auto !important;
    }

    .summary-card-body {
      padding: 0 !important;
    }

    .summary-card-header {
      margin-top: 0 !important;
      margin-bottom: 1rem !important;
      padding: 12px 12px 12px 60px !important;
      min-height: 50px;
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: space-between !important;
    }

    .appointment-card {
      margin-left: 0 !important;
      margin-right: 0 !important;
      margin-bottom: 1px !important;
      /* Divider effect */
      border-radius: 0 !important;
      border-left: none !important;
      border-right: none !important;
      width: 100% !important;
    }

    .app-title {
      max-width: none !important;
      white-space: normal !important;
      font-size: 1rem !important;
    }

    .summary-title {
      font-size: 1.1rem !important;
    }

    .summary-subtitle {
      display: none !important;
    }

    .summary-list {
      gap: 0 !important;
      padding: 0 !important;
    }

    .tab-content {
      margin-top: 0 !important;
    }

    body {
      padding-top: 0 !important;
      background: var(--vet-bg-surface) !important;
      overflow-x: hidden !important;
    }

    /* Simplified tab structure for mobile focus */
    .tab-pane.active {
      display: block !important;
      opacity: 1 !important;
    }

    .tab-pane:not(.active) {
      display: none !important;
    }
  }

  .brand-logo {
    background: rgba(255, 255, 255, 0.15);
    width: 140px;
    height: 140px;
    border-radius: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    flex-shrink: 0;
    box-shadow: var(--vet-shadow-md);
  }

  .brand-chip {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.7rem;
  }

  .brand-chip .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 0 8px #fff;
  }

  .card,
  .summary-card,
  .premium-card,
  .drop-zone-surface {
    background: var(--vet-bg-surface) !important;
    border-radius: 32px !important;
    border: 1px solid var(--vet-border-light) !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.04) !important;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card:hover,
  .summary-card:hover,
  .premium-card:hover,
  .drop-zone-surface:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.08) !important;
  }

  .card-body {
    padding: 2.5rem !important;
  }

  .card-title,
  .summary-title {
    font-weight: 800;
    font-size: 1.5rem;
    letter-spacing: -0.04em;
    color: var(--vet-text-main);
    line-height: 1.1;
  }

  .hero-floating-actions {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    z-index: 5;
  }

  .hero-stat-mini {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 20px;
    padding: 0.85rem 1.75rem;
    text-align: center;
    min-width: 120px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .hero-stat-mini:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .hero-stat-mini:active {
    transform: translateY(0) scale(0.98);
  }

  .mini-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 800;
    opacity: 0.85;
    letter-spacing: 0.1em;
    display: block;
    margin-bottom: 4px;
  }

  .mini-value {
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .hero-stats-cluster {
    display: flex;
    gap: 1.25rem;
  }

  .btn-glass {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: #fff;
    border-radius: 12px;
    padding: 0.6rem 1.25rem;
    font-weight: 700;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: 0.2s;
  }

  .btn-glass:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  .summary-stat-box {
    padding: 1.5rem;
    background: var(--vet-bg-subtle);
    border-radius: var(--vet-radius-lg);
    border: 1px solid var(--vet-border-light);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: transform 0.2s ease;
  }

  .summary-stat-box:hover {
    transform: translateY(-4px);
    border-color: var(--vet-primary);
  }

  .stat-label {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--vet-text-muted);
    text-transform: uppercase;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--vet-primary-strong);
  }

  .hero-stat-mini {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 14px;
    padding: 0.6rem 1rem;
    display: flex;
    flex-direction: column;
    min-width: 85px;
    text-align: center;
  }

  .mini-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    font-weight: 800;
    opacity: 0.7;
    letter-spacing: 0.05em;
    margin-bottom: 1px;
  }

  .mini-value {
    font-size: 1rem;
    font-weight: 800;
  }

  .hero-floating-actions {
    position: absolute;
    top: 2rem;
    right: 2rem;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .hero-stats-cluster {
    display: flex;
    gap: 0.75rem;
  }

  .btn-glass {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    padding: 0.6rem 1.25rem;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    transition: all 0.2s;
  }

  .btn-glass:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    color: #fff;
  }

  /* SUMMARY TAB SPECIFIC */
  .summary-card-body {
    padding: 2.5rem 2rem;
  }

  .summary-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-left: 0.15rem;
    /* Fix clipping */
  }

  .summary-title {
    font-weight: 800;
    font-size: 1.25rem;
    letter-spacing: -0.01em;
    color: var(--vet-text-main);
    margin-bottom: 0.25rem;
  }

  .summary-subtitle {
    font-size: 0.85rem;
    color: var(--vet-text-secondary);
    margin-bottom: 0;
  }

  .summary-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .appointment-card,
  .file-card {
    background: var(--vet-bg-surface);
    border: 1px solid var(--vet-border-light);
    border-radius: 16px;
    padding: 1.25rem;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .appointment-card:hover,
  .file-card:hover {
    transform: translateY(-2px);
    border-color: var(--vet-primary);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
  }

  .appointment-card::before,
  .file-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--vet-primary);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .appointment-card:hover::before,
  .file-card:hover::before {
    opacity: 1;
  }

  /* CUSTOM SCROLLBARS */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  ::-webkit-scrollbar-track {
    background: transparent;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  .app-title {
    font-weight: 700;
    color: var(--vet-text-main);
    font-size: 1rem;
  }

  .app-time {
    font-size: 0.8rem;
    color: var(--vet-text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  /* KPI BOXES */
  .summary-kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
  }

  .summary-kpi {
    background: var(--vet-bg-subtle);
    border-radius: var(--vet-radius-lg);
    padding: 1.25rem;
    border: 1px solid var(--vet-border-light);
    transition: all 0.2s;
  }

  .summary-kpi:hover {
    border-color: var(--vet-primary);
    transform: translateY(-3px);
  }

  .summary-kpi-label {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--vet-text-muted);
    letter-spacing: 0.05em;
  }

  .summary-kpi-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--vet-primary);
    line-height: 1.2;
    margin-top: 0.25rem;
  }

  /* ACTION BUTTONS */
  .summary-actions {
    display: grid;
    gap: 0.75rem;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .summary-action {
    background: var(--vet-bg-surface);
    border: 1px solid var(--vet-border-light);
    border-radius: var(--vet-radius-md);
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s;
    font-weight: 700;
    color: var(--vet-text-main);
    cursor: pointer;
  }

  .summary-action:hover {
    background: var(--vet-primary);
    color: #fff;
    border-color: var(--vet-primary);
    transform: translateX(4px);
    box-shadow: 0 10px 20px -5px color-mix(in srgb, var(--vet-primary), transparent 50%);
  }

  /* FULLCALENDAR HEADERS FIX */
  .fc .fc-col-header-cell {
    background: var(--vet-bg-subtle) !important;
    padding: 8px 0 !important;
    border-bottom: 2px solid var(--vet-primary) !important;
    vertical-align: middle !important;
    min-height: 28px !important;
  }

  .fc .fc-col-header-cell-cushion {
    color: var(--vet-text-main, #0f172a) !important;
    font-weight: 800 !important;
    text-transform: uppercase !important;
    font-size: 0.72rem !important;
    letter-spacing: 0.02em !important;
    display: block !important;
    width: 100% !important;
    text-align: center !important;
    padding: 2px 4px !important;
    text-decoration: none !important;
    white-space: normal !important;
    line-height: 1.2 !important;
    min-height: 24px !important;
  }

  [data-theme="dark"] .fc .fc-col-header-cell-cushion {
    color: #e2e8f0 !important;
  }

  body.fc-custom-weekdays .fc .fc-scrollgrid-section-header {
    display: none !important;
  }

  .calendar-weekday-strip {
    display: grid;
    grid-template-columns: var(--fc-axis-width, 0px) repeat(var(--fc-day-count, 7), minmax(0, 1fr));
    align-items: center;
    gap: 0;
    margin: 0.35rem 0 0.5rem;
    border-radius: 12px;
    border: 1px solid color-mix(in srgb, var(--vet-primary), transparent 70%);
    background: color-mix(in srgb, var(--vet-primary), white 85%);
    overflow: hidden;
    position: relative;
    z-index: 2;
    width: 100%;
    flex: 0 0 100%;
    order: 20;
  }

  .calendar-weekday-strip[data-view="daygrid"] {
    grid-template-columns: repeat(7, minmax(0, 1fr));
  }

  .calendar-weekday-strip.d-none {
    display: none !important;
  }

  .calendar-weekday-axis {
    height: 100%;
    border-right: 1px solid color-mix(in srgb, var(--vet-primary), transparent 80%);
  }

  .calendar-weekday-cell {
    text-align: center;
    padding: 6px 0;
    font-weight: 800;
    font-size: 0.72rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: var(--vet-primary-strong);
    border-right: 1px solid color-mix(in srgb, var(--vet-primary), transparent 80%);
  }

  .calendar-weekday-cell:last-child {
    border-right: none;
  }

  [data-theme="dark"] .calendar-weekday-strip {
    background: color-mix(in srgb, var(--vet-primary), #0f172a 80%);
    border-color: color-mix(in srgb, var(--vet-primary), transparent 60%);
  }

  [data-theme="dark"] .calendar-weekday-cell {
    color: #e2e8f0;
  }

  .fc .fc-timegrid-slot {
    height: 60px !important;
    border-bottom: 1px dashed var(--vet-border-light) !important;
  }

  .fc .fc-timegrid-slot-label-cushion {
    font-size: 0.75rem !important;
    font-weight: 700 !important;
    color: var(--vet-text-muted) !important;
  }

  .fc .fc-scrollgrid {
    border: none !important;
    border-radius: var(--vet-radius-md) !important;
    overflow: visible !important;
  }

  /* ICON BUTTONS */
  .btn-icon-soft {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: none;
    background: var(--vet-bg-subtle);
    color: var(--vet-text-secondary);
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
  }

  .btn-icon-soft:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .btn-icon-soft.primary {
    background: var(--vet-primary-subtle);
    color: var(--vet-primary);
  }

  .btn-icon-soft.primary:hover {
    background: var(--vet-primary);
    color: #fff;
  }

  .btn-icon-soft.danger {
    background: #fff1f2;
    color: #e11d48;
  }

  .btn-icon-soft.danger:hover {
    background: #e11d48;
    color: #fff;
  }

  /* OVERRIDES */
  .slug-input-group .input-group-text {
    background: var(--vet-bg-subtle);
    border-color: var(--vet-border-light);
    color: var(--vet-primary);
    font-weight: 700;
  }
</style>
{% endblock %}

{% block content %}
<div id="upload-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
  style="background: rgba(0,0,0,0.35); z-index: 1050; backdrop-filter: blur(2px);">
  <div class="d-flex justify-content-center align-items-center h-100">
    <div class="text-white fw-semibold fs-4">Subiendo archivos...</div>
  </div>
</div>

<div class="side-overlay" id="sideOverlay"></div>

<div class="page-shell">
  <!-- PREMIUM SIDE NAV -->
  <aside class="side-nav collapsed" id="sideNav">
    <div class="px-2 mb-4">
      <div class="d-flex align-items-center gap-3 mb-1">
        <div class="bg-primary rounded-3 text-white d-flex align-items-center justify-content-center shadow-sm"
          style="width: 32px; height: 32px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
        </div>
        <span class="fw-bold h5 mb-0" style="font-family: 'Lexend', sans-serif;">Vetflow</span>
      </div>
      <div class="text-muted small px-1 opacity-75">{{ current_user_email or 'Mi cuenta' }}</div>
    </div>

    <div class="side-section-title">Menú Principal</div>
    <button class="side-link" data-tab-target="summary">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <rect width="7" height="9" x="3" y="3" rx="1" />
        <rect width="7" height="5" x="14" y="3" rx="1" />
        <rect width="7" height="9" x="14" y="12" rx="1" />
        <rect width="7" height="5" x="3" y="16" rx="1" />
      </svg>
      Dashboard
    </button>
    <button class="side-link" data-tab-target="calendar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
      Agenda
    </button>
    <button class="side-link" data-tab-target="files">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
        <polyline points="14.5 2 14.5 8 20 8" />
      </svg>
      Documentos
    </button>
    <button class="side-link" data-tab-target="clients">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
      Clientes
    </button>
    <button class="side-link" data-tab-target="whatsapp">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 11.5a8.38 8.38 0 0 1-1.1 4.2 8.5 8.5 0 0 1-7.4 4.3 8.38 8.38 0 0 1-4.2-1.1L3 21l1.9-5.3a8.38 8.38 0 0 1-1.1-4.2 8.5 8.5 0 0 1 4.3-7.4 8.38 8.38 0 0 1 4.2-1.1h.5a8.48 8.48 0 0 1 8.2 8.5Z" />
      </svg>
      WhatsApp
    </button>

    <div class="side-section-title">Configuración</div>
    <div class="dropdown px-2 mb-2">
      <button
        class="btn btn-sm btn-light w-100 d-flex justify-content-between align-items-center rounded-3 border-0 py-2"
        type="button" data-bs-toggle="dropdown" style="background: rgba(0,0,0,0.04);">
        <span class="text-truncate fw-semibold">{{ current_workspace.name if current_workspace else "Áreas" }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m6 9 6 6 6-6" />
        </svg>
      </button>
      <ul class="dropdown-menu shadow-lg border-0" style="border-radius: 12px; min-width: 220px;">
        <li class="px-3 py-2 small fw-bold text-uppercase opacity-50">Mis Espacios</li>
        {% for ws in workspaces %}
        <li><a class="dropdown-item d-flex align-items-center gap-2 py-2"
            href="{{ url_for('ui.workspace_by_slug', slug=ws.schema_name) }}">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: {{ ws.theme_color or '#6366f1' }}">
            </div>
            {{ ws.name }}
          </a></li>
        {% endfor %}
        <li>
          <hr class="dropdown-divider">
        </li>
        <li><a class="dropdown-item small" href="#" data-bs-toggle="modal" data-bs-target="#createWorkspaceModal">+
            Crear nuevo</a></li>
      </ul>
    </div>

    <div class="mt-auto d-flex flex-column gap-1">
      <button class="side-link border-0 text-danger opacity-75" data-bs-toggle="modal"
        data-bs-target="#deleteWorkspaceModal" style="font-size: 0.85rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18" />
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
        Eliminar Área
      </button>
    </div>
  </aside>

  <div class="main-content-wrapper">
    {% if current_workspace %}
    <div class="brand-hero"
      style="background: linear-gradient(135deg, {{ current_workspace.theme_color or '#6c47ff' }} 0%, color-mix(in srgb, {{ current_workspace.theme_color or '#6c47ff' }}, black 15%) 100%);">
      <div class="hero-content-left">
        <div class="brand-logo">
          {% if current_workspace and current_workspace.icon_url %}
          <img src="{{ current_workspace.icon_url }}" alt="Logo"
            onerror="this.onerror=null; this.src='/static/img/control-vet-logo.png'; this.style.filter='brightness(0) invert(1)';"
            style="max-width: 100px; max-height: 100px; object-fit: contain;">
          {% else %}
          <img src="{{ url_for('static', filename='img/control-vet-logo.png') }}" alt="Logo"
            style="max-width: 100px; filter: brightness(0) invert(1);">
          {% endif %}
        </div>

        <div class="hero-info-text text-start">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="brand-chip px-3 py-1 rounded-pill d-flex align-items-center gap-2">
              <span class="dot"></span>
              <span class="text-uppercase fw-bold ls-1">{{ current_workspace.name }}</span>
            </div>
            <div class="brand-chip px-3 py-1 rounded-pill" style="opacity: 0.9;">
              <span class="small fw-bold opacity-75">OWNER:</span>
              <span class="small fw-bold">{{ current_workspace.owner_name or "S/N" }}</span>
            </div>
          </div>

          <h1 class="brand-title" style="margin: 0; font-size: clamp(2rem, 3.5vw, 3.5rem); line-height: 1;">{{
            current_workspace.name }}</h1>
          <p class="brand-subtitle opacity-75 mt-2 mb-0" style="max-width: 600px;">
            {{ current_workspace.description or "Gestor documental y agenda conectada a RAG para tu clínica." }}
          </p>
        </div>
      </div>

      <div class="hero-content-right">
        {% if current_membership_role == 'owner' %}
        <button class="btn-glass" data-bs-toggle="modal" data-bs-target="#editWorkspaceModal">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9" />
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
          </svg>
          Gestionar Clínica
        </button>
        {% endif %}

        <div class="hero-stats-cluster">
          <div class="hero-stat-mini" data-tab-target="files">
            <span class="mini-label">Archivos</span>
            <span class="mini-value text-white">{{ files|length }}</span>
          </div>
          <div class="hero-stat-mini" data-tab-target="calendar">
            <span class="mini-label">Citas</span>
            <span class="mini-value text-white">{{ appointments|length }}</span>
          </div>
        </div>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="tab-content">
      <div class="tab-pane fade show active" id="summary" role="tabpanel">
        <div class="summary-grid" data-summary-panel
          data-workspace-slug="{{ current_workspace.schema_name if current_workspace else '' }}">
          <!-- LEFT: APPOINTMENTS LIST -->
          <div class="summary-card">
            <div class="summary-card-body">
              <div class="summary-card-header">
                <div>
                  <h3 class="summary-title">Próximas Citas</h3>
                  <p class="summary-subtitle">Gestiona tu agenda reciente</p>
                </div>
                <div class="d-flex align-items-center">
                  <span class="badge rounded-pill bg-primary-subtle text-primary fw-bold px-3 py-2"
                    data-summary-upcoming-count>
                    {{ (appointments_upcoming|default(appointments))|length }}
                  </span>
                </div>
              </div>
              <div class="summary-list" data-summary-appointments-list>
                {% for c in appointments_upcoming|default(appointments) %}
                <div class="appointment-card" data-appointment-id="{{ c.id }}">
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <div class="app-title text-truncate" style="max-width: 280px;" title="{{ c.title }}">{{ c.title }}
                      </div>
                      <span class="status-badge status-{{ c.status|default('programada') }}"
                        style="font-size:0.65rem; padding: 0.1rem 0.6rem; border-radius: 99px;">
                        {{ appointment_status_labels[c.status]|default(c.status|capitalize) }}
                      </span>
                    </div>
                    <div class="app-time">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      <span class="appointment-date" data-datetime="{{ c.start_time }}">{{ (c.start_time|string)[:10]
                        }}</span>
                      <span class="opacity-50 mx-1">/</span>
                      <span class="appointment-hour" data-datetime="{{ c.start_time }}">{{ (c.start_time|string)[11:16]
                        }}</span>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-5 mt-4">
                  <div class="mb-3 opacity-25">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                      <line x1="16" y1="2" x2="16" y2="6" />
                      <line x1="8" y1="2" x2="8" y2="6" />
                      <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                  </div>
                  <div class="fw-bold">No hay citas programadas</div>
                  <div class="small opacity-75">Tu agenda aparece vacía por ahora</div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- RIGHT: KPI STACK -->
          <div class="summary-stack d-flex flex-column gap-4">
            <!-- KPIs Card -->
            <div class="summary-card">
              <div class="summary-card-body">
                <div class="d-flex align-items-center gap-2 mb-4">
                  <div class="p-2 bg-primary-subtle rounded-3 text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M3 3v18h18" />
                      <path d="m19 9-5 5-4-4-3 3" />
                    </svg>
                  </div>
                  <h5 class="mb-0 fw-bold">Estadísticas</h5>
                </div>

                <div class="summary-kpis">
                  <div class="summary-kpi">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="summary-kpi-label">Archivos</div>
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                        class="opacity-50">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                        <polyline points="14.5 2 14.5 8 20 8" />
                      </svg>
                    </div>
                    <div class="summary-kpi-value text-primary">{{ files|length }}</div>
                  </div>
                  <div class="summary-kpi">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="summary-kpi-label">Citas</div>
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                        class="opacity-50">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                      </svg>
                    </div>
                    <div class="summary-kpi-value text-primary" data-summary-total-count>{{ appointments|length }}</div>
                  </div>
                  <div class="summary-kpi">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="summary-kpi-label">Miembros</div>
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                        class="opacity-50">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      </svg>
                    </div>
                    <div class="summary-kpi-value text-primary">{{ workspace_members|length }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Access Card -->
            <div class="summary-card">
              <div class="summary-card-body">
                <div class="d-flex align-items-center gap-2 mb-4">
                  <div class="p-2 bg-primary-subtle rounded-3 text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m5 11 4-7" />
                      <path d="m19 11-4-7" />
                      <path d="M2 11h20" />
                      <path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8a2 2 0 0 0 2-1.6l1.7-7.4" />
                      <path d="m9 11 1 9" />
                      <path d="m15 11-1 9" />
                    </svg>
                  </div>
                  <h5 class="mb-0 fw-bold">Atajos</h5>
                </div>

                <div class="summary-actions">
                  <button class="summary-action border-0" type="button" data-tab-target="calendar">
                    <span class="d-flex align-items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                      </svg>
                      Calendario
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                  </button>

                  <button class="summary-action border-0" type="button" data-tab-target="files">
                    <span class="d-flex align-items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                        <polyline points="14.5 2 14.5 8 20 8" />
                      </svg>
                      Mis Archivos
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                  </button>

                  <button class="summary-action border-0" type="button" data-tab-target="clients">
                    <span class="d-flex align-items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      </svg>
                      Clientes
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="files" role="tabpanel">
        {% include "partials/files_tab.html" %}
      </div>
      <div class="tab-pane fade" id="calendar" role="tabpanel">
        {% include "partials/calendar_tab.html" %}
      </div>
      <div class="tab-pane fade" id="clients" role="tabpanel">
        {% include "clientes.html" %}
      </div>
      <div class="tab-pane fade" id="whatsapp" role="tabpanel">
        {% include "partials/whatsapp_tab.html" %}
      </div>
    </div>
    {% else %}
    <div class="first-workspace-wrapper">
      <div class="first-workspace-card">
        <div class="first-workspace-copy">
          <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill mb-3 px-3 py-2">Nuevo usuario</span>
          <h2>Configura tu primer workspace</h2>
          <p class="text-muted">
            Un workspace agrupa tus archivos, agenda y miembros. Elige un nombre y un URL único.
            Este formulario creará la base de datos aislada y te añadirá como propietario.
          </p>
          <ul class="text-muted small ps-3">
            <li>Puedes invitar a tu equipo luego desde el panel.</li>
            <li>El URL solo acepta letras, números y guiones.</li>
            <li>Todo se crea automáticamente en PostgreSQL.</li>
          </ul>
        </div>
        <form method="POST" action="{{ url_for('ui.create_workspace_route') }}" class="d-flex flex-column gap-3"
          data-workspace-form enctype="multipart/form-data">
          <div>
            <label class="form-label">Nombre del workspace</label>
            <input type="text" class="form-control form-control-lg" name="workspace_name"
              value="{{ current_user_name or '' }}" data-slug-source required placeholder="Control Vet">
          </div>
          <div>
            <label class="form-label">URL del workspace</label>
            <div class="input-group slug-input-group">
              <span class="input-group-text">app.vetflow.local/</span>
              <input type="text" class="form-control form-control-lg" name="workspace_slug" data-slug-field required
                placeholder="control-vet">
            </div>
            <div class="text-muted slug-helper mt-1">Sin espacios, se permiten letras minúsculas, números y guiones.
            </div>
          </div>
          <div>
            <label class="form-label">Color del tema</label>
            <div class="d-flex gap-2">
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color1_def" value="#6c47ff" checked
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color1_def"
                  style="width: 32px; height: 32px; background-color: #6c47ff; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color2_def" value="#dc2626"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color2_def"
                  style="width: 32px; height: 32px; background-color: #dc2626; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color3_def" value="#2563eb"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color3_def"
                  style="width: 32px; height: 32px; background-color: #2563eb; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color4_def" value="#16a34a"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color4_def"
                  style="width: 32px; height: 32px; background-color: #16a34a; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color5_def" value="#06b6d4"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color5_def"
                  style="width: 32px; height: 32px; background-color: #06b6d4; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Icono (Opcional)</label>
            <input class="form-control" type="file" name="workspace_icon" accept="image/*">
          </div>
          <div>
            <label class="form-label">Descripcion</label>
            <textarea class="form-control" name="workspace_description" rows="3"
              placeholder="Agenda conectada a RAG para mi clínica."></textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Correo del propietario</label>
              <input type="email" class="form-control" name="owner_email" value="{{ current_user_email or '' }}"
                required placeholder="tu-correo@gmail.com">
            </div>
            <div class="col-md-6">
              <label class="form-label">Nombre del propietario</label>
              <input type="text" class="form-control" name="owner_name" value="{{ current_user_name or '' }}"
                placeholder="Nombre completo">
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-lg mt-2">Crear workspace</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
{% block modals %}
<!-- Modal de eventos del dia -->
<div class="modal fade" id="dayEventsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayEventsTitle">Citas del dia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="dayEventsBody">
      </div>
    </div>
  </div>
</div>

<!-- Modal crear/editar cita rapida -->
<div class="modal fade quick-event-modal" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
    <div class="modal-content shadow quick-event-card">
      <div class="modal-header border-0 pb-0">

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createEventForm" class="quick-event-form">
        <div class="modal-body pt-0">
          <input type="text" class="form-control form-control-lg quick-event-title" id="eventTitleInput"
            placeholder="Agregar titulo" required>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="8" />
                <path d="M12 8v4l3 1.8" />
              </svg>
            </div>
            <div class="quick-event-datetime">
              <input type="datetime-local" class="form-control" id="eventStartInput" required>
              <span class="quick-event-separator">dur</span>
              <select class="form-select" id="eventDurationSelect" required>
                <option value="" selected disabled>Duracion</option>
                <option value="15">15 min</option>
                <option value="30">30 min</option>
                <option value="60">1 h</option>
                <option value="90">1 h 30</option>
                <option value="120">2 h</option>
                <option value="custom">Otra...</option>
              </select>
              <input type="number" class="form-control d-none" id="eventDurationCustom" min="5" step="5"
                placeholder="Minutos">
            </div>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 4h7l5 5v11H8z" />
                <path d="M15 4v5h5" />
                <path d="M11 14h7" />
                <path d="M11 18h7" />
              </svg>
            </div>
            <textarea class="form-control" id="eventDescInput" rows="2"
              placeholder="Agregar descripcion o notas"></textarea>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="7" />
                <circle cx="12" cy="12" r="3" />
                <path d="M12 5v2" />
                <path d="M12 17v2" />
                <path d="M5 12h2" />
                <path d="M17 12h2" />
              </svg>
            </div>
            <select class="form-select" id="eventStatusSelect">
              {% for status in appointment_statuses %}
              <option value="{{ status.value }}">{{ status.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="quick-event-row">
            <div class="quick-event-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0" />
                <circle cx="12" cy="9" r="4" />
              </svg>
            </div>
            <select class="form-select" id="eventClientSelect">
              <option value="">Cliente (opcional)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0 flex-column flex-sm-row gap-2 justify-content-between align-items-start">
          <div class="text-muted small" id="eventRangeLabel"></div>
          <div class="d-flex gap-2 w-100 justify-content-sm-end">
            <button type="button" class="btn btn-light flex-fill flex-sm-grow-0"
              data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary flex-fill flex-sm-grow-0">Crear</button>
          </div>
        </div>
        <input type="hidden" id="eventStartIso">
        <input type="hidden" id="eventEndIso">
      </form>
    </div>
  </div>
</div>

<!-- Modal crear workspace -->
<div class="modal fade" id="createWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('ui.create_workspace_route') }}" data-workspace-form
        enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Nuevo workspace</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre del workspace</label>
            <input type="text" class="form-control" name="workspace_name" required placeholder="Control Vet"
              data-slug-source>
          </div>
          <div class="mb-3">
            <label class="form-label">URL del workspace</label>
            <div class="input-group slug-input-group">
              <span class="input-group-text">app.vetflow.local/</span>
              <input type="text" class="form-control" name="workspace_slug" placeholder="control-vet" data-slug-field>
            </div>
            <small class="text-muted">Solo letras minúsculas, números y guiones.</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Color del tema</label>
            <div class="d-flex gap-2">
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color1_modal" value="#6c47ff" checked
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color1_modal"
                  style="width: 32px; height: 32px; background-color: #6c47ff; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color2_modal" value="#dc2626"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color2_modal"
                  style="width: 32px; height: 32px; background-color: #dc2626; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color3_modal" value="#2563eb"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color3_modal"
                  style="width: 32px; height: 32px; background-color: #2563eb; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color4_modal" value="#16a34a"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color4_modal"
                  style="width: 32px; height: 32px; background-color: #16a34a; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="color5_modal" value="#06b6d4"
                  autocomplete="off">
                <label class="btn rounded-circle d-flex align-items-center justify-content-center shadow-sm"
                  for="color5_modal"
                  style="width: 32px; height: 32px; background-color: #06b6d4; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Icono (Opcional)</label>
            <input class="form-control" type="file" name="workspace_icon" accept="image/*">
          </div>
          <div class="mb-3">
            <label class="form-label">Descripcion</label>
            <textarea class="form-control" name="workspace_description" rows="2"
              placeholder="Uso interno del equipo"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Correo del propietario (Gmail)</label>
            <input type="email" class="form-control" name="owner_email" required placeholder="owner@example.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Nombre del propietario</label>
            <input type="text" class="form-control" name="owner_name" placeholder="Nombre completo">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear workspace</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal editar workspace -->
<div class="modal fade" id="editWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <form method="POST" action="{{ url_for('ui.update_workspace_route', workspace_id=current_workspace.id) }}"
        enctype="multipart/form-data">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Editar área de trabajo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">Nombre del workspace</label>
            <input type="text" class="form-control" name="workspace_name" required value="{{ current_workspace.name }}"
              placeholder="Control Vet">
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Color del tema</label>
            <div class="d-flex gap-2">
              {% for color in ["#6c47ff", "#dc2626", "#2563eb", "#16a34a", "#06b6d4"] %}
              <div class="form-check p-0">
                <input type="radio" class="btn-check" name="theme_color" id="edit_color_{{ loop.index }}"
                  value="{{ color }}" {% if current_workspace.theme_color==color %}checked{% endif %}
                  autocomplete="off">
                <label class="btn rounded-circle shadow-sm border-2" for="edit_color_{{ loop.index }}"
                  style="width: 36px; height: 36px; background-color: {{ color }}; border: 2px solid #fff; outline: 1px solid #ddd;"></label>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Cambiar Icono</label>
            <div class="d-flex align-items-center gap-3 mb-2">
              {% if current_workspace.icon_url %}
              <img src="{{ current_workspace.icon_url }}" class="rounded shadow-sm" onerror="this.style.display='none';"
                style="width: 48px; height: 48px; object-fit: contain; background: #f8f9fa;">
              {% endif %}
              <input class="form-control" type="file" name="workspace_icon" accept="image/*">
            </div>
            <small class="text-muted">Sube una imagen cuadrada para mejores resultados.</small>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Descripción</label>
            <textarea class="form-control" name="workspace_description" rows="3"
              placeholder="Breve descripción del área">{{ current_workspace.description or "" }}</textarea>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal invitar a workspace -->
<div class="modal fade" id="inviteWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="inviteWorkspaceForm"
        data-workspace-slug="{{ current_workspace.schema_name if current_workspace else '' }}">
        <div class="modal-header">
          <h5 class="modal-title">Invitar a workspace</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Correo de la persona</label>
            <input type="email" class="form-control" name="invite_email" required placeholder="equipo@clinica.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Duracion del enlace (dias, opcional)</label>
            <input type="number" class="form-control" name="invite_expires" min="0" max="365"
              placeholder="Sin vencimiento">
            <div class="form-text">Deja vacio o 0 para que no expire.</div>
          </div>
          <div class="alert alert-info small mb-2">
            Generamos un codigo unico y lo guardamos en la base. Copialo y compartelo por correo/chat.
          </div>
          <div class="small fw-semibold" id="inviteWorkspaceStatus"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Enviar invitacion</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal aceptar invitacion -->
<div class="modal fade" id="acceptInviteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="acceptInviteForm">
        <div class="modal-header">
          <h5 class="modal-title">Unirme con codigo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Codigo</label>
            <input type="text" class="form-control" name="invite_code" required placeholder="ej. 1mJ5W2Gc">
          </div>
          <div class="mb-3">
            <label class="form-label">Tu correo</label>
            <input type="email" class="form-control" name="invite_email" required placeholder="tu-correo@clinica.com"
              value="{{ current_user_email or '' }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Tu nombre (opcional)</label>
            <input type="text" class="form-control" name="invite_name" placeholder="Nombre completo"
              value="{{ current_user_name or '' }}">
          </div>
          <div class="alert alert-info small mb-2">
            Usaremos el codigo para agregarte al workspace. Si es correcto, te redirigimos al panel.
          </div>
          <div class="small fw-semibold" id="acceptInviteStatus"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Unirme</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal miembros workspace -->
<div class="modal fade" id="membersWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Miembros del workspace</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if workspace_members %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Correo</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Ingreso</th>
                {% if current_membership_role == 'owner' %}<th></th>{% endif %}
              </tr>
            </thead>
            <tbody>
              {% for m in workspace_members %}
              <tr>
                <td>{{ m.email }}</td>
                <td>{{ m.display_name or 'Sin nombre' }}</td>
                <td>
                  <span
                    class="badge {% if m.role == 'owner' %}bg-primary{% elif m.role == 'admin' %}bg-info{% else %}bg-secondary{% endif %}">
                    {{ m.role|capitalize }}
                  </span>
                </td>
                <td class="text-muted small">{{ m.joined_at }}</td>
                {% if current_membership_role == 'owner' %}
                <td class="text-end">
                  {% if m.role != 'owner' %}
                  <button class="btn btn-sm btn-outline-danger" type="button" data-remove-member
                    data-member-email="{{ m.email }}">Quitar</button>
                  {% endif %}
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-light mb-0">
          No hay miembros cargados para este workspace.
        </div>
        {% endif %}
        <div id="membersRemoveStatus" class="small fw-semibold mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal eliminar workspace -->
<div class="modal fade" id="deleteWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger">Eliminar workspace</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('ui.delete_workspace_route') }}" id="deleteWorkspaceForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Selecciona el workspace a eliminar</label>
            <select class="form-select" name="workspace_id" id="deleteWorkspaceSelect" required>
              <option value="" disabled selected>Elige workspace</option>
              {% for ws in workspaces %}
              <option value="{{ ws.id }}">{{ ws.name }} ({{ ws.slug }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="alert alert-warning">
            <div class="fw-bold">Si eliminas este workspace se perderá toda la información (archivos y citas).</div>
            <div>Escribe exactamente: <code>eliminar esta area trabajo</code> para confirmar.</div>
          </div>
          <div class="mb-2">
            <label class="form-label">Confirmación</label>
            <input type="text" class="form-control" name="confirmation_phrase" id="deleteWorkspacePhrase"
              placeholder="eliminar esta area trabajo" autocomplete="off" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger" id="deleteWorkspaceSubmit" disabled>Eliminar
            definitivamente</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.vetflowData = {
    appointments: {{ appointments | tojson }}
  };
  window.vetflowStatuses = {{ appointment_statuses | tojson }};
  window.vetflowStatusLabels = {{ appointment_status_labels | tojson }};
</script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="{{ url_for('static', filename='js/calendar.js') }}?v=13"></script>
<script src="{{ url_for('static', filename='js/fullcalendar.js') }}?v=15"></script>
<script src="{{ url_for('static', filename='js/whatsapp.js') }}?v=26"></script>
<script src="{{ url_for('static', filename='js/clientes.js') }}?v=2"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.__renderCalendar) {
      try { window.__renderCalendar(); } catch (err) { console.warn('Legacy calendar render error', err); }
    }

    const sideNav = document.getElementById('sideNav');
    const sideOverlay = document.getElementById('sideOverlay');
    const toggleSide = (open) => {
      const shouldOpen = typeof open === 'boolean' ? open : sideNav?.classList.contains('collapsed');
      if (shouldOpen) {
        sideNav?.classList.remove('collapsed');
        sideOverlay?.classList.add('open');
      } else {
        sideNav?.classList.add('collapsed');
        sideOverlay?.classList.remove('open');
      }
    };
    document.getElementById('toggleSideNav')?.addEventListener('click', () => toggleSide());
    sideOverlay?.addEventListener('click', () => toggleSide(false));

    const setActiveTab = (target) => {
      document.querySelectorAll('.side-link').forEach((btn) => btn.classList.toggle('active', btn.dataset.tabTarget === target));
      document.querySelectorAll('.tab-pane').forEach((pane) => {
        pane.classList.remove('show', 'active');
        if (pane.id === target) pane.classList.add('show', 'active');
      });
      document.body?.setAttribute('data-active-tab', target);
      if (target === 'calendar' && window.__renderCalendar) {
        try { window.__renderCalendar(); } catch (e) { console.error(e); }
      }
      if (target === 'calendar') {
        window.dispatchEvent(new Event('vetflow:calendarTabActivated'));
      }
      localStorage.setItem('vetflow_active_tab', target);
    };

    document.querySelectorAll('[data-tab-target]').forEach((el) => {
      el.addEventListener('click', () => {
        const target = el.getAttribute('data-tab-target');
        setActiveTab(target);
        toggleSide(false);
      });
    });

    const calendarTab = document.getElementById('calendar');
    const summaryTab = document.getElementById('summary');
    const defaultTab = calendarTab ? 'calendar' : (summaryTab ? 'summary' : 'calendar');
    const savedTab = localStorage.getItem('vetflow_active_tab');
    const savedTabExists = savedTab && document.getElementById(savedTab);
    setActiveTab(savedTabExists ? savedTab : defaultTab);

    // arrancamos colapsado en desktop; en mobile se abre con el overlay
    toggleSide(false);
  });
</script>
<script>
  (() => {
    const panel = document.querySelector('[data-summary-panel]');
    if (!panel) return;

    const slug = panel.getAttribute('data-workspace-slug') || '';
    const apiBase = slug ? `/w/${encodeURIComponent(slug)}/api/calendar` : '/api/calendar';
    const listEl = panel.querySelector('[data-summary-appointments-list]');
    const countEl = panel.querySelector('[data-summary-upcoming-count]');
    const totalEl = panel.querySelector('[data-summary-total-count]');
    const upcomingEl = panel.querySelector('[data-summary-upcoming-kpi]');
    const nextEl = panel.querySelector('[data-summary-next]');
    const refreshMs = 2000;
    let refreshTimer = null;
    let hasLoaded = false;
    let previousIds = new Set();
    const soundUrl = "{{ url_for('static', filename='music/ta-da_yrvBrlS.mp3') }}";
    const summarySound = new Audio(soundUrl);
    summarySound.preload = 'auto';
    summarySound.volume = 0.7;
    let soundUnlocked = false;
    let soundPending = false;

    const playSound = () => {
      if (!soundUnlocked) {
        soundPending = true;
        return;
      }
      try {
        summarySound.currentTime = 0;
        const playPromise = summarySound.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch(() => { });
        }
      } catch { }
    };

    const unlockSound = () => {
      if (soundUnlocked) return;
      soundUnlocked = true;
      if (soundPending) {
        soundPending = false;
        playSound();
      }
    };

    document.addEventListener('pointerdown', unlockSound, { once: true });
    document.addEventListener('keydown', unlockSound, { once: true });
    document.addEventListener('touchstart', unlockSound, { once: true });

    const pad2 = (n) => String(n).padStart(2, '0');
    const formatDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    const formatTime = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const parseDate = (value) => {
      if (!value) return null;
      const d = new Date(value);
      return Number.isNaN(d.getTime()) ? null : d;
    };
    const escapeHtml = (value) =>
      String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const statusLabel = (status) => {
      const labels = window.vetflowStatusLabels || {};
      const key = String(status || 'programada').toLowerCase();
      const fallback = key ? `${key.charAt(0).toUpperCase()}${key.slice(1)}` : 'Programada';
      return labels[key] || fallback;
    };

    const emptyHtml = `
      <div class="text-center text-muted py-5">
        <div class="mb-2 opacity-50">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        </div>
        <div class="small fw-semibold">Sin citas programadas</div>
        <div class="small opacity-75">para este periodo</div>
      </div>
    `;

    const renderAppointment = (appt) => {
      const title = escapeHtml(appt.title || '(Sin titulo)');
      const status = String(appt.status || 'programada').toLowerCase();
      const label = escapeHtml(statusLabel(status));
      const start = appt.startDate || appt.endDate || null;
      const dateText = start ? formatDate(start) : '--';
      const timeText = start ? formatTime(start) : '--:--';
      const datetime = escapeHtml(appt.start_time || appt.end_time || '');

      return `
        <div class="appointment-card" data-appointment-id="${escapeHtml(appt.id)}">
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div class="app-title text-truncate" style="max-width: 220px;" title="${title}">${title}</div>
              <span class="status-badge status-${status}" style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
                ${label}
              </span>
            </div>
            <div class="app-time">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
              </svg>
              <span class="appointment-date" data-datetime="${datetime}">${dateText}</span>
              <span class="text-muted mx-1">-</span>
              <span class="appointment-hour" data-datetime="${datetime}">${timeText}</span>
            </div>
          </div>
        </div>
      `;
    };

    const renderNext = (appt) => {
      if (!nextEl) return;
      if (!appt) {
        nextEl.classList.add('text-muted');
        nextEl.innerHTML = 'No hay citas programadas por ahora.';
        return;
      }
      nextEl.classList.remove('text-muted');
      const title = escapeHtml(appt.title || '(Sin titulo)');
      const status = String(appt.status || 'programada').toLowerCase();
      const label = escapeHtml(statusLabel(status));
      const start = appt.startDate || appt.endDate || null;
      const dateText = start ? formatDate(start) : '--';
      const timeText = start ? formatTime(start) : '--:--';
      const datetime = escapeHtml(appt.start_time || appt.end_time || '');
      nextEl.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="summary-next-name text-truncate" style="max-width: 220px;" title="${title}">${title}</div>
          <span class="status-badge status-${status}" style="font-size:0.65rem; padding: 0.1rem 0.4rem;">
            ${label}
          </span>
        </div>
        <div class="app-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
          </svg>
          <span class="appointment-date" data-datetime="${datetime}">${dateText}</span>
          <span class="text-muted mx-1">-</span>
          <span class="appointment-hour" data-datetime="${datetime}">${timeText}</span>
        </div>
      `;
    };

    const updateCounts = (total, upcoming) => {
      if (countEl) countEl.textContent = String(upcoming);
      if (totalEl) totalEl.textContent = String(total);
      if (upcomingEl) upcomingEl.textContent = String(upcoming);
    };

    const refreshSummary = async () => {
      try {
        const res = await fetch(apiBase, { headers: { Accept: 'application/json' }, cache: 'no-store' });
        const data = await res.json().catch(() => []);
        if (!res.ok) return;
        const items = Array.isArray(data) ? data : [];
        const nowTs = Date.now();
        const withDates = items.map((appt) => {
          const startDate = parseDate(appt.start_time);
          const endDate = parseDate(appt.end_time);
          const startTs = startDate ? startDate.getTime() : null;
          const endTs = endDate ? endDate.getTime() : null;
          const bestTs = Math.max(startTs ?? -Infinity, endTs ?? -Infinity);
          return { ...appt, startDate, endDate, startTs, endTs, bestTs };
        });
        const upcoming = withDates
          .filter((appt) => Number.isFinite(appt.bestTs) && appt.bestTs >= nowTs)
          .sort((a, b) => (a.startTs ?? a.bestTs) - (b.startTs ?? b.bestTs));

        updateCounts(items.length, upcoming.length);

        const visibleUpcoming = upcoming.slice(0, 50);
        if (listEl) {
          if (!visibleUpcoming.length) {
            listEl.innerHTML = emptyHtml;
          } else {
            listEl.innerHTML = visibleUpcoming.map(renderAppointment).join('');
          }
        }
        renderNext(visibleUpcoming[0]);

        const nextIds = new Set(
          visibleUpcoming
            .map((appt) => String(appt.id ?? '').trim())
            .filter((id) => id.length)
        );
        if (hasLoaded) {
          let hasNew = false;
          nextIds.forEach((id) => {
            if (!previousIds.has(id)) hasNew = true;
          });
          if (hasNew) playSound();
        } else {
          hasLoaded = true;
        }
        previousIds = nextIds;
      } catch (err) {
        console.warn('Summary refresh failed', err);
      }
    };

    const startRefreshLoop = () => {
      if (refreshTimer) return;
      refreshTimer = setInterval(refreshSummary, refreshMs);
    };

    const openDetail = async (appointmentId) => {
      if (!appointmentId) return;
      try {
        const url = `${apiBase}/${encodeURIComponent(appointmentId)}`;
        const res = await fetch(url, { headers: { Accept: 'application/json' }, cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return;
        const startDate = parseDate(data.start_time);
        const endDate = parseDate(data.end_time);
        const eventPayload = {
          id: data.id,
          title: data.title,
          description: data.description || '',
          status: data.status || 'programada',
          start: startDate,
          end: endDate,
          client_id: data.client_id ?? null,
        };
        if (window.vetflowCalendar?.openEventModal) {
          window.vetflowCalendar.openEventModal(eventPayload);
          return;
        }
        if (typeof window.openEdit === 'function') {
          window.openEdit(
            Number(eventPayload.id),
            String(eventPayload.title || ''),
            String(eventPayload.description || ''),
            data.start_time || '',
            data.end_time || '',
            String(eventPayload.status || 'programada'),
            eventPayload.client_id
          );
        }
      } catch (err) {
        console.warn('No se pudo abrir detalle de cita', err);
      }
    };

    const init = () => {
      refreshSummary();
      startRefreshLoop();
      if (listEl) {
        listEl.addEventListener('click', (event) => {
          const card = event.target.closest('.appointment-card');
          if (!card || !listEl.contains(card)) return;
          const id = card.getAttribute('data-appointment-id');
          if (!id) return;
          openDetail(id);
        });
      }
      document.querySelectorAll('[data-tab-target="summary"]').forEach((btn) => {
        btn.addEventListener('click', refreshSummary);
      });
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) refreshSummary();
      });
      window.addEventListener('vetflow:calendarChanged', refreshSummary);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
<script>
  (() => {
    const fetchSasUrl = async (fileId) => {
      const res = await fetch(`/file/${fileId}/sas`, {
        headers: {
          'Accept': 'application/json'
        }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || `Error ${res.status}`);
      }
      if (!data.url) {
        throw new Error('Respuesta sin URL SAS');
      }
      return data.url;
    };

    window.openFile = async (fileId) => {
      if (!fileId) {
        console.warn('openFile llamado sin id');
        return;
      }
      const previewWindow = window.open('', '_blank');
      if (previewWindow && previewWindow.document) {
        previewWindow.document.body.innerHTML = '<div style="font-family:system-ui,sans-serif;padding:16px;">Abriendo archivo...</div>';
      }
      try {
        const sasUrl = await fetchSasUrl(fileId);
        if (previewWindow) {
          previewWindow.location = sasUrl;
        } else {
          window.open(sasUrl, '_blank', 'noopener');
        }
      } catch (err) {
        if (previewWindow && !previewWindow.closed) {
          previewWindow.close();
        }
        console.error('No se pudo abrir el archivo', err);
        const msg = err && err.message ? err.message : 'No se pudo generar el enlace SAS';
        alert(`No se pudo abrir el archivo: ${msg}`);
      }
    };
  })();
</script>
<script>
  (() => {
    // Toggle panel de citas sin que se mueva el layout
    // const toggleBtn = document.querySelector('[data-appointments-toggle]');
    // const panel = document.querySelector('[data-appointments-panel]');
    // if (toggleBtn && panel) {
    //   const syncState = () => {
    //     const isHidden = panel.classList.contains('hidden-panel');
    //     toggleBtn.setAttribute('aria-expanded', String(!isHidden));
    //   };
    //   toggleBtn.addEventListener('click', () => {
    //     panel.classList.toggle('hidden-panel');
    //     syncState();
    //   });
    //   syncState();
    // }
  })();
</script>
<script>
  (() => {
    // Confirmación de borrado de workspace
    const phraseInput = document.getElementById('deleteWorkspacePhrase');
    const selectInput = document.getElementById('deleteWorkspaceSelect');
    const submitBtn = document.getElementById('deleteWorkspaceSubmit');
    const requiredPhrase = 'eliminar esta area trabajo';

    const validate = () => {
      const phraseOk = (phraseInput?.value || '').trim().toLowerCase() === requiredPhrase;
      const wsOk = !!(selectInput && selectInput.value);
      if (submitBtn) {
        submitBtn.disabled = !(phraseOk && wsOk);
      }
    };

    phraseInput?.addEventListener('input', validate);
    selectInput?.addEventListener('change', validate);
    validate();
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('inviteWorkspaceForm');
    if (!form) return;
    const statusEl = document.getElementById('inviteWorkspaceStatus');
    const submitBtn = form.querySelector('[type="submit"]');
    const emailInput = form.querySelector('input[name="invite_email"]');
    const expiresInput = form.querySelector('input[name="invite_expires"]');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const resetForm = () => {
      form.reset();
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar invitacion';
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('', null);
      const slug = form.dataset.workspaceSlug;
      const email = (emailInput?.value || '').trim();
      const expiresRaw = expiresInput?.value;
      if (!slug) {
        setStatus('Selecciona un workspace antes de invitar.', 'error');
        return;
      }
      if (!email) {
        setStatus('Ingresa un correo', 'error');
        return;
      }
      const payload = { email };
      if (expiresRaw !== undefined && expiresRaw !== '') {
        payload.expires_in_days = Number(expiresRaw);
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }

      try {
        const res = await fetch(`/w/${slug}/api/invites`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || `Error ${res.status}`);
        }
        const code = data?.invite?.invite_code ? ` Codigo: ${data.invite.invite_code}` : '';
        setStatus(`Invitacion creada.${code}`, 'success');
        form.reset();
      } catch (err) {
        setStatus(err?.message || 'No se pudo crear la invitacion', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar invitacion';
        }
      }
    });

    const modalEl = document.getElementById('inviteWorkspaceModal');
    if (modalEl) {
      modalEl.addEventListener('hidden.bs.modal', resetForm);
    }
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('acceptInviteForm');
    if (!form) return;
    const statusEl = document.getElementById('acceptInviteStatus');
    const submitBtn = form.querySelector('[type="submit"]');
    const codeInput = form.querySelector('input[name="invite_code"]');
    const emailInput = form.querySelector('input[name="invite_email"]');
    const nameInput = form.querySelector('input[name="invite_name"]');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const resetForm = () => {
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Unirme';
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = (codeInput?.value || '').trim();
      const email = (emailInput?.value || '').trim();
      const name = (nameInput?.value || '').trim();
      if (!code || !email) {
        setStatus('Ingresa codigo y correo', 'error');
        return;
      }
      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }
      try {
        const res = await fetch('/api/invites/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, email, name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || `Error ${res.status}`);
        }
        const slug = data?.workspace?.schema_name || data?.workspace?.slug;
        setStatus('Invitacion aceptada. Redirigiendo...', 'success');
        if (slug) {
          setTimeout(() => { window.location = `/w/${slug}`; }, 500);
        } else {
          setTimeout(() => { window.location.reload(); }, 500);
        }
      } catch (err) {
        setStatus(err?.message || 'No se pudo aceptar la invitacion', 'error');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Unirme';
        }
      }
    });

    const modalEl = document.getElementById('acceptInviteModal');
    if (modalEl) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        form.reset();
        resetForm();
      });
    }
  })();
</script>
<script>
  (() => {
    const removeButtons = document.querySelectorAll('[data-remove-member]');
    if (!removeButtons.length) return;
    const statusEl = document.getElementById('membersRemoveStatus');
    const workspaceSlug = "{{ current_workspace.schema_name if current_workspace else '' }}";

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    removeButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const email = btn.getAttribute('data-member-email');
        if (!workspaceSlug || !email) return;
        if (!confirm(`¿Quitar a ${email} del workspace?`)) return;
        btn.disabled = true;
        setStatus('', null);
        try {
          const res = await fetch(`/w/${workspaceSlug}/api/members/remove`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data.error || `Error ${res.status}`);
          }
          setStatus('Miembro removido. Recargando...', 'success');
          setTimeout(() => window.location.reload(), 500);
        } catch (err) {
          setStatus(err?.message || 'No se pudo remover', 'error');
        } finally {
          btn.disabled = false;
        }
      });
    });
  })();
</script>
<script>
  (() => {
    const slugify = (value) =>
      String(value || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 48);

    const attachSlugSync = (form) => {
      const nameInput = form.querySelector('[data-slug-source]');
      const slugInput = form.querySelector('[data-slug-field]');
      if (!nameInput || !slugInput) return;
      let slugTouched = slugInput.value.trim().length > 0;

      const setSlugValue = (value) => {
        const next = slugify(value);
        slugInput.value = next;
      };

      nameInput.addEventListener('input', () => {
        if (slugTouched) return;
        setSlugValue(nameInput.value);
      });

      slugInput.addEventListener('input', () => {
        slugTouched = slugInput.value.trim().length > 0;
        setSlugValue(slugInput.value);
      });

      if (!slugTouched) {
        setSlugValue(nameInput.value || slugInput.value);
      }
    };

    document.querySelectorAll('[data-workspace-form]').forEach(attachSlugSync);
  })();
</script>
<script>
  (() => {
    // Drag and Drop para archivos
    const dropZone = document.getElementById('filesDropZone');
    const overlay = document.getElementById('filesDropOverlay');
    const fileInput = document.getElementById('fileInput');
    const uploadDrawer = document.getElementById('uploadDrawer');
    const label = document.getElementById('selectedFilesLabel');

    if (!dropZone || !overlay || !fileInput) return;

    // Prevent defaults globalmente para evitar que el navegador abra el archivo
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Detectar drag sobre todo el documento para mostrar overlay
    let dragCounter = 0;
    document.body.addEventListener('dragenter', (e) => {
      dragCounter++;
      if (dragCounter === 1) {
        overlay.classList.add('active');
        // Asegurar que estamos en la tab de archivos si no lo estamos? 
        // Por ahora asumimos que solo importa si el usuario quiere soltar.
      }
    });

    document.body.addEventListener('dragleave', (e) => {
      dragCounter--;
      if (dragCounter === 0) {
        overlay.classList.remove('active');
      }
    });

    document.body.addEventListener('drop', (e) => {
      dragCounter = 0;
      overlay.classList.remove('active');

      const dt = e.dataTransfer;
      const files = dt.files;

      if (files && files.length > 0) {
        // Asignar archivos al input
        fileInput.files = files;

        // Actualizar etiqueta
        if (label) {
          label.textContent = files.length + ' archivo(s) seleccionados para subir';
        }

        // Abrir el drawer si está cerrado
        if (uploadDrawer && !uploadDrawer.classList.contains('show')) {
          // Usar Bootstrap API si está disponible o fallback manual
          // Si tenemos bootstrap global:
          try {
            const bsCollapse = new bootstrap.Collapse(uploadDrawer, { show: true });
          } catch (err) {
            // Fallback simple por si bootstrap no esta en window
            uploadDrawer.classList.add('show');
          }
        }

        // Hacemos scroll suave hacia el formulario
        uploadDrawer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('textUploadForm');
    if (!form) return;

    const titleInput = document.getElementById('textNoteTitle');
    const tagsInput = document.getElementById('textNoteTags');
    const notesInput = document.getElementById('textNoteNotes');
    const contentInput = document.getElementById('textNoteContent');
    const statusEl = document.getElementById('textNoteStatus');
    const submitBtn = document.getElementById('textNoteSubmit');

    const setStatus = (msg, type) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.remove('text-danger', 'text-success');
      if (type === 'error') statusEl.classList.add('text-danger');
      if (type === 'success') statusEl.classList.add('text-success');
    };

    const safeFilename = (value) =>
      String(value || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9_-]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 48)
        .toLowerCase();

    const timestampSuffix = () => {
      const now = new Date();
      const pad = (num) => String(num).padStart(2, '0');
      return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const content = (contentInput?.value || '').trim();
      if (!content) {
        setStatus('Escribe una nota antes de subir.', 'error');
        contentInput?.focus();
        return;
      }

      const rawTitle = (titleInput?.value || '').trim();
      const safeTitle = safeFilename(rawTitle);
      const filename = safeTitle ? `${safeTitle}.txt` : `nota-${timestampSuffix()}.txt`;

      const file = new File([content], filename, { type: 'text/plain' });
      const formData = new FormData();
      formData.append('file', file);

      const tags = (tagsInput?.value || '').trim();
      const notes = (notesInput?.value || '').trim();
      if (tags) formData.append('tags', tags);
      if (notes) formData.append('notes', notes);

      setStatus('', null);
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subiendo...';
      }

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        if (!res.ok) {
          throw new Error(`Error ${res.status}`);
        }
        setStatus('Nota creada. Recargando...', 'success');
        form.reset();
        setTimeout(() => window.location.reload(), 600);
      } catch (err) {
        setStatus('No se pudo subir la nota.', 'error');
        console.error('Error subiendo nota', err);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear TXT';
        }
      }
    });
  })();
</script>

<script>
  // CALENDAR SIDEBAR RESIZER
  (() => {
    const resizer = document.getElementById('calendarResizer');
    const panel = document.getElementById('appointmentsCollapse');
    if (!resizer || !panel) return;

    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      resizer.classList.add('resizing');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;

      const windowWidth = window.innerWidth;
      // El panel está a la derecha, calculamos desde la derecha
      const newWidth = windowWidth - e.clientX - 20; // 20 de margen aproximado

      if (newWidth > 200 && newWidth < windowWidth * 0.5) {
        panel.style.width = `${newWidth}px`;
        panel.style.flex = `0 0 ${newWidth}px`;

        // Disparar resize para que el calendario se ajuste
        window.dispatchEvent(new Event('resize'));
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        resizer.classList.remove('resizing');
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';

        // Guardar preferencia? Opcional.
        localStorage.setItem('vetflow_calendar_sidebar_width', panel.style.width);
      }
    });

    // Cargar ancho guardado
    const savedWidth = localStorage.getItem('vetflow_calendar_sidebar_width');
    if (savedWidth && window.innerWidth > 992) {
      panel.style.width = savedWidth;
      panel.style.flex = `0 0 ${savedWidth}`;
    }

    // Sincronizar con el botón de colapsar
    panel.addEventListener('hidden.bs.collapse', () => {
      resizer.style.setProperty('display', 'none', 'important');
    });
    panel.addEventListener('shown.bs.collapse', () => {
      if (window.innerWidth > 992) {
        resizer.style.setProperty('display', 'block', 'important');
      }
    });
  })();
</script>
{% endblock %}
