<div id="filesDropZone" class="drop-zone-wrapper">
  <div id="filesDropOverlay" class="drop-zone-overlay">
    <div>
      <div>Suelta tus archivos aqui</div>
      <div class="small text-muted">Los agregaremos al formulario de subida</div>
    </div>
  </div>

  <div class="card drop-zone-surface">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
        <div>
          <h5 class="card-title mb-1">Archivos de pacientes</h5>
          <p class="section-subtitle">Gestiona documentos, thumbnails y envialos al bot para su procesamiento.</p>
        </div>
        <button class="btn btn-primary d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse"
          data-bs-target="#uploadDrawer" aria-expanded="false">
          <span class="quick-create-dot"></span>
          Nuevo archivo
        </button>
      </div>

      <div class="collapse mb-4" id="uploadDrawer">
        <div class="upload-drawer p-3 p-md-4 rounded-4 border">
          <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
            <div class="upload-droparea mb-3" onclick="document.getElementById('fileInput').click()">
              <input id="fileInput" type="file" name="file" multiple required
                onchange="document.getElementById('selectedFilesLabel').textContent = this.files.length ? (this.files.length + ' archivo(s) seleccionados') : 'Arrastra o haz clic para seleccionar tus archivos';"
                style="display:none;">
              <div class="upload-droparea-content text-center">
                <div class="fw-semibold mb-1">Arrastra y suelta tus estudios, recetas o fotos</div>
                <p class="text-muted mb-2">o haz clic para elegirlos desde tu equipo</p>

                <div class="small text-muted mt-2" id="selectedFilesLabel">Arrastra o haz clic para seleccionar tus
                  archivos</div>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-md-4">
                <input type="text" name="tags" class="form-control" placeholder="tags (ej. felino, vacuna, RX)">
              </div>
              <div class="col-md-5">
                <input type="text" name="notes" class="form-control" placeholder="Notas del paciente">
              </div>
              <div class="col-md-3 d-grid">
                <button id="uploadBtn" class="btn btn-primary" type="submit">Subir a Control Vet</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="d-flex flex-column gap-2 mb-4">
        {% for f in files %}
        {% set st = (f.status or 'uploaded')|lower %}
        <div class="appointment-card p-3">
          <div
            style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: #f3f0ff; border-radius: 8px;">
            {% if f.thumbnail_url and st != 'expired' %}
            <img src="{{ f.thumbnail_url }}" alt="thumb"
              style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; cursor: pointer;"
              onclick="openFile({{ f.id }})">
            {% else %}
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="#6f3df4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
              <polyline points="14 2 14 8 20 8" />
            </svg>
            {% endif %}
          </div>

          <div class="flex-grow-1 overflow-hidden" style="min-width: 0;">
            <div class="d-flex align-items-center gap-2 mb-1">
              <div class="fw-bold text-dark" onclick="openFile({{ f.id }})"
                style="cursor:pointer; white-space: normal; word-break: break-all; line-height: 1.2;"
                title="{{ f.filename }}">{{ f.filename }}</div>

              {% if st == 'uploaded' %}
              <span class="badge bg-warning text-dark status-badge flex-shrink-0">Pendiente</span>
              {% elif st in ['active', 'activo', 'processed', 'done'] %}
              <span class="badge bg-success status-badge flex-shrink-0">Activo</span>
              {% elif st == 'processing' %}
              <span class="badge bg-info text-dark status-badge flex-shrink-0">Proc.</span>
              {% elif st in ['deleting', 'eliminando'] %}
              <span class="badge bg-warning text-dark status-badge flex-shrink-0">Elim.</span>
              {% elif st in ['expired', 'expirada'] %}
              <span class="badge bg-secondary status-badge flex-shrink-0">Exp.</span>
              {% else %}
              <span class="badge bg-light text-dark status-badge flex-shrink-0">{{ st[:3] }}</span>
              {% endif %}
            </div>
            <div class="text-muted small text-truncate d-flex align-items-center gap-1">
              <span>{{ (f.created_at|string)[:10] if f.created_at else '' }}</span>
              {% if f.tags %}
              <span>•</span>
              <span>{{ f.tags[0] }}{% if f.tags|length > 1 %} +{{ f.tags|length - 1 }}{% endif %}</span>
              {% endif %}
            </div>
          </div>

          <div class="dropdown">
            <button class="btn btn-icon-soft" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1" />
                <circle cx="12" cy="5" r="1" />
                <circle cx="12" cy="19" r="1" />
              </svg>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-2"
              style="border-radius: 12px; min-width: 200px;">
              <li><button class="dropdown-item rounded-2 mb-1 d-flex align-items-center gap-2"
                  onclick="openFile({{ f.id }})">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  Ver archivo
                </button></li>

              <li>
                <form action="/files/{{ f.id }}/send-to-n8n" method="post" class="m-0">
                  {% if st in ['expired', 'expirada', 'deleting', 'eliminando'] %}
                  <button class="dropdown-item rounded-2 mb-1 d-flex align-items-center gap-2 disabled text-muted"
                    type="button" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                    Enviar al bot
                  </button>
                  {% else %}
                  <button class="dropdown-item rounded-2 mb-1 d-flex align-items-center gap-2" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="#0ea5e9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                    Enviar al bot
                  </button>
                  {% endif %}
                </form>
              </li>

              <li>
                <hr class="dropdown-divider my-1">
              </li>

              <li>
                <form action="/files/{{ f.id }}/delete" method="post" class="m-0"
                  onsubmit="return confirm('¿Borrar este archivo?');">
                  {% if st in ['deleting', 'eliminando'] %}
                  <button class="dropdown-item rounded-2 d-flex align-items-center gap-2 text-warning" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                      <path d="M21 3v5h-5" />
                    </svg>
                    Reintentar borrado
                  </button>
                  {% else %}
                  <button class="dropdown-item rounded-2 d-flex align-items-center gap-2 text-danger" type="submit" {%
                    if st in ['expired', 'expirada' , 'deleting' ] %}disabled{% endif %}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6" />
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                    Eliminar
                  </button>
                  {% endif %}
                </form>
              </li>
            </ul>
          </div>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
          <div class="mb-3 opacity-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
          </div>
          <p>No hay archivos aun</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>